<html><head></head><body><strong><span style="font-size:large;"></span></strong><span style="font-weight:700;"><span style="font-size:large;">Введение</span></span><br>Приложение построено как SPA с использованием AngularJS версии 1.5<br>Роутинг клиентский с использованием AgularUI Router`a<br>Центральный файл ip-saas\WebContent\src\app.js<br><br>Основные файлы настроек SPA-приложения<br>В настройках хранятся такие важные параметры как формат дат и времени, префикс адреса сервера, выбор между входом по логину или email`у. В нем можно отключать серверную агрегацию или менять частоту автообновления форм списка. <br>ip-saas\WebContent\src\config.js - хранит основные настройки в экспортируемом объекте Config<br>ip-saas\WebContent\src\constants.js - устаревающий, используется только в FlyData, хранит основные настройки в ангуляр-модуле IpConstants, обновлять для новых модулей не нужно.<br>Для установки настроек для отдельного стенда используется значение sha256(window.location.host).<br>Для нового стенда значения вычисляются при помощи файла ip-saas\test.js и копируются в исходник уже хешем.<br>Если в будущем будут производится отдельные сборки для каждого стенда со своими параметрами командной строки, то можно вместо этого использовать webpack, например https://webpack.js.org/plugins/define-plugin/ вместе с параметрами командной строки. Это позволит не привязывать настройки к IP адресам, которые могут меняться.<br><br><span style="font-size:large;"><span style="font-weight:700;">Описание библиотек и системы сборки</span></span><br><br><span style="font-weight:700;"><em>Библиотеки</em></span><br>Исторически все файлы CSS и JS, как библиотек, так и исходного кода импортировались просто при помощи тегов link и script в файле index.html<br>Для уменьшения числа запросов на сервер, возможности использовать Babel и ESLint, автодополнение в редакторе и упрощения описания модульных тестов сейчас практически весь исходный код (вместе с html и css) собирается в единый файл. Исключение составляет файл стилей ip-saas\WebContent\styles\main.css описание стилей из которого постепенн переносится в файлы стилей внутри отдельных компонентов приложения.<br><br>Большая часть библиотек пока попрежнему находится в папке ip-saas\WebContent\vendor и импортируется тегами script, стили библиотек находится в папке ip-saas\WebContent\styles ипортируются также просто как link, также для библиотек прописаны глобальные константы в ip-saas\.eslintrc. Исключение составляют библиотеки lodash и momentjs, которые импортируются внутри приложения через ES6 import, а в Webpack подключаются через externals.<br>В ходе обновления кода приложения рекомендуется сменить способ подключения библиотек на явный импорт через ES6 в использующем их файле и установке через npm i --save. При этом рекомендуется ставить версию совпадающую с версией в ip-saas\WebContent\vendors и впоследствии отдельно обновлять, проверяя работоспособность. После этого обращение к библиотеке в коде заменяется на импорт, глобальная переменная удаляется из ip-saas\.eslintrc. Далее возможны два варианта. Для редких библиотек их дистрибутив просто удаляется из ip-saas\WebContent\vendor. Для библиотек, которые есть на многих сайтах, типа AngularJS или JQuery в файле webpack.config.js в настройке externals прописывается название их глоабальной переменной. Во втором случае с одной стороны нормально работает ESLint и автодополнение, с другой нормально работает кеширование библиотеки в браузере и остается доступ к глобальной константе из консоли. Вторым способом сейчас собираются lodash (часто есть в браузерах и бывает удобен доступ к переменной _ из консоли) и momentjs (при сборке Webpack`ом добавляет полмегабайта линих локалей). Старый способом лучше оставить для подключения библиотеки kendo.<br> <br><em><strong>Система сборки</strong></em><br>Для сборки приложения используется npm (ставится вместе с NodeJS) и webpack (установленнный глобально через npm i -g webpack).<br>Перед запуском сборки не забываем обновить зависимости<br>npm i<br>Рассмотрим основные скрипты в ip-saas\package.json (с этого рекомендуется начинать знакомство с вообще любым JS приложением, не только с IdeaPlatform)<br>    "build": "webpack", - запуск webpack c дефолтным файлом конфигурации webpack.config.js в режиме слежения за файлами<br>    "build:prod": "webpack --prod", - запуск webpack c дефолтным файлом конфигурации webpack.config.js с передачей метки для прод-сборки<br>    "test": "karma start karma.conf.js --single-run", - одиночный запуск тестов<br>    "test:watch": "karma start karma.conf.js" - запуск тестов в режиме слежения за файлами<br><br>Остановимся на командах Webpack`у webpack.config.js<br>В начале выясняется имя пользователя и режим (development/production) по ним нстраевается папка для установки. Желающие могут добавить для себя отдельный путь установки или обрабатывать его передачу через командную строку - Webpack используются стандартные переменные NodeJS.<br>Теперь рассмотрим основные настройки<br>    entry - точка входа приложения, добавляем полифил Babel, устанавливаем точкой входа ip-saas\WebContent\src\app.js<br>    output - устанавливается имя собранного файла, для production-сборки дописывается хеш. Устанавливается имя app по которому в index.html запускается функция run из app.js<br>    externals - имена библиотек, которые подключаются через импорт, но не включаются в сборку (о них описано в пункте "библиотеки").<br>    watch - работать в режиме слежения за файлами (для development-сборок) или в режиме одиночной сборки (для production-сборок), watchOptions - как часто отслеживать изменения в файлах<br>    devtool - режим генерации sourcemap`ов подробнее https://webpack.github.io/docs/configuration.html#output-devtoollinetoline<br>    plugins <br>        - NoErrorsPlugin - не собирать новую версию при наличии ошибок<br>        - DefinePlugin - описание констант, которые можно использовать в исходном коде<br>        - ContextReplacementPlugin - обработка библиотек с неудачным для webpack форматом экспорта, в данном случае momentjs<br>        - SftpWebpackPlugin (добавляется в конце файла для одной из настроек) - на одном из стендов я заливаю собраный файл build.js по SFTP <br>    Обработчик описанный как последний плагин выполняет замену имени 'build.js' на 'build.[hash].js' для production-сборок в файле ip-saas\WebContent\src\index.html, после чего копирует измененный index.html по адресу outputPath<br>    resolve и resolveLoader - какие библиотечные модули как разбирать<br>    module.preloaders - включает eslint для development-сборок<br>    module.loaders - описание загрузчиков (массив из названий в поле loaders) для разных типов файлов (регулярка в поле test), если для одного типа файла нужно несколько последовательных загрузчиков, то они указываются в порядке обратном порядку применения<br>        module.loaders[0] <br>            test: /\.css$/, - для файлов оканчивающихся на .css<br>            loaders: ['style-loader', 'css-loader'] - сначала парсим файл css-loader'ом и получам из него стили, потом эти стили приделываем к итоговому build.js при помощи style-loader<br>        module.loaders[1] <br>            test: /\.scss$/, - для файлов оканчивающихся на .scss<br>            loaders: ['style-loader', 'css-loader', 'sass-loader'] - сначала парсим файлы sass-loader'ом и получаем стандартный CSS, потом тоже что и в предыдущем<br>        module.loaders[2] <br>            test: /\.js$/, - для файлов оканчивающихся на .js<br>            exclude: /(node_modules|bower_components)/, - библиотечные файлы уже обработаны Babel'ем<br>            loader: 'babel', - обрабатываем файлы Babel'ем чтобы получить стандартный ES5<br>        module.loaders[3] <br>            test: /\.ts/, - для файлов оканчивающихся на .ts<br>            exclude: /(node_modules|bower_components)/,<br>            loaders:  ['babel-loader', 'ts-loader'] - дополнительная обработка Babel'ем в случае если используем функции TypeScript недоступные при компиляции в ES5<br>        module.loaders[4] <br>            test: /\.html$/,- для файлов оканчивающихся на .html<br>            include: [<br>                path.resolve(__dirname, 'WebContent/src') - только внутри  ip-saas\WebContent\src\<br>            ],<br>            loader: 'ngtemplate?relativeTo=' + (path.resolve(__dirname, 'WebContent/src')) + '/!html' - сначала загружаем их html-loader'ом, потом ngtemplate-loader'ом вкомпиливаем в build.js код который сразу кладет их $templateCache<br>        <br><span style="font-size:large;"><strong>Центральная точка входа в приложение </strong></span><br>Рассмотрим ip-saas\WebContent\src\app.js. Весь код обернут в функцию run, которая вызывается из index.html<br>Вначале регистируется основной angular-модуль ideaPlatformApp в которой добавляются основные модули приложения. У тех модулей у которых есть настройки роутинга при этом также настраивается UIRouter.<br>Далее регистрируются настройки UIRouter для страницы логина и лендинга, для старых модулей на FlyData, а также правила роутинга, которые должны применяться последними (view и view_row)<br>После этого регистрируется перенаправление после запросов с ошибкой 401 на страницу логина и настроки Google Analytics.<br><br><span style="font-size:large;"><strong>Модули и компоненты приложения</strong></span><br>Для удобство разобьем все angular-модули приложения на несколько групп по смыслу<br>В дальнейшем под модулем приложения будет пониматься angular-модуль, включающий в себя отдельную страницу в роуторе, новые модули (под ViewData) сами себя регистрируют в роуторе в файле ip-saas\WebContent\src\[module-name]\index.js при первом обращении к модулю, настройки при этом стандартно кладутся в ip-saas\WebContent\src\[module-name]\route.js. Старые компоненты (под FlyData) регистрируется в app.js. Примеры новых модулей IpQueryView, IpDashboardView, FormEditorPageView, IpSearchView. <br>Под компонентом понимается angular-модуль, включающий в себя какую-то директиву, примеры: IpSelect, IpMultiattachment. Компоненты используются внутри модулей.<br>Сервисы - angular-модуль, включающий в себя какой-то глобально необходимый в нескольких модулях angular-сервис или angular-фабрика. Примеры: IpAlerts, IpConnection, IpAuth, IpAccount, раньше ими были IpConvert и IpConstants, но сейчас IpConvert рекомендуется использовать как просто импортируемые функции, а вместо IpConstants - глобальный объект Config.<br>Технически вcё это разбиение условно, например IpModalView технически скорее сервис (не имеет своего роута), но по составу информации он схож IpQueryView и IpSearchView, поэтому я его буду считать модулем. Однако такое разбиение позволяет лучше понять, что есть в приложении для чего оно используется и как связано.<br><br>Итак, основные модули (новые):<br><strong>IpMenuView </strong>- модуль отвечающий за работу меню. Находится на большинстве страниц.<br>    menuComponent - основной компонент меню<br>    AlertsMenuButtonControllerView - просто обработчик кнопки с конвертом<br>    AlertsListControllerView - контроллер модального окна от кнопки с конвертом<br>    MenuDataView - сервис получения данных для меню от сервера<br><strong>IpQueryView </strong>- модуль отвечающий за показ таблиц и представлений "списочного типа". К помимо основного ViewType = LIST к таким относятся SIMPLE_LIST, TREE_LIST, BAR_CHART, PIE_CHART, MULTI_PLOT, PIVOT_TABLE, SCHEDULER, GANTT, NEWS_FEED.<br>Основой функционал модуля сосредоточен в компоненте IpQueryComponent, в QueryViewController описана обработка проброса URL в поля поиска и формы одной записи, если она передана в URL<br>    IpQueryComponent - компонент реализующий общие методы используемые представлениями "списочного типа" при показе их в нескольких возможных местах: на форме списка, на форме одной записи в качестве виртуального поля и на дашборде. <br>    Внутри себе содержит два компонента: форму поиска поиска - показывается только на форме списка при соответствующих настройках, списочный компонент соответствующего типа.<br>    Настройки формы поиска (searchWidgetOptions searchCallbackOptions) позволяют реагировать на смену параметров, пробрасывать их в отчет и на URL, а также реагировать на высоту и сжимать вкладку формы.<br>        this.searchWidgetOptions и this.searcEnvironmentOptions - настройки виджета формы поиска<br>        this.searchCallbackOptions<br>            destroyWidget - уничтожение виджета (чтобы не было утечек)<br>            setData - установить данные в форме<br>            getData - получить данные из формы<br>            onDataChanged - функция вызывается формой при нажатии кнопки "Показать"<br><br>        Настройки высот для синхронизации высоты вкладки с параметрами и высоты компонента списка<br>        this.searchCallbackOptions<br>            getOpenHeight: unOverriddenFunction,<br>            getClosedHeight: unOverriddenFunction,<br>            setHeight: unOverriddenFunction,<br>            onSizeChanged: (isOpenNow) => this.heightResizer && this.heightResizer.resize(isOpenNow)<br>    <br>    Параметры поиска (внешние, внутренние и по умолчанию)<br>    Все компоненты внутри IpQueryComponent могут иметь и автоматически реагировать такие параметры (указаны в порядке возрастания приоритета):<br>        this.options.queryParameters - параметры поиска из URL<br>        this.options.outerFormValues - значение полей с формы<br>        this.widgetOptions && this.widgetOptions.fieldsDefaultValues - дефолтные значения<br>        this.options.dashboardParametes - значения параметров дашборда <br>        this.searchOptions - собственные значения параметров (настраиваемы формой поиска) <br>    Приоритет определяется в getSearchParameters<br><br>    Настройки списочного отчета состоят из widgetOptions - список параметров определяемых сервером, outerOptions - список параметров определяемых окружением, dataSource - список методов для работы с сервером (запросить данные, обновить строку и т.д.) и сервисами (открыть форму одной записи, связанный отчет) и callbackOptions - список функций для передачи информации из компонента списка в сам IpQueryComponent (поменялась высота) и методов работы с списком (обновить список, уничтожить список и т.д.) Эти методы списочный компонент должен переопределить сам.<br><br>    Рассмотрим получение данных <strong>IpQueryComponent </strong>и создаваемый dataSource более подробно. IpQueryComponent рассчитан на то, что его можно построить практически только по имени или номеру view. Это связано с тем, что на форме списка при первом рендеринге странице вся инфорация есть только URL, а у формы одной записи и дашборда отчеты грузятся по отдельности также по их view. Чтобы не запрашивать два раза данные с сервера сначала с метаданными, а потом с данными, запрос сразу содержит и данные и метаданные. При этом запрос для обновления данных (dataSource.read) использует запрос тот же запрос для получения первоночальных данных, но при первом обращении берет уже переданные данные. Соответственно, если используются настройки по умолчанию для поиска фильтрации, списка колонок, то их нужно реализоваывать на сервере для первичной загрузки.<br>        <strong>IdeaGridView </strong>ip-saas\WebContent\src\grid-view - список используется для ViewType = LIST и SIMPLE_LIST<br>            Основной файл: ip-saas\WebContent\src\grid-view\idea-grid.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaGridView, использует http://demos.telerik.com/kendo-ui/grid/index<br>                Компонент для фильтрации использует queryBuilderView - ip-saas\WebContent\vendor\query-builder.standalone.min.js<br>                kendo.filtermenu.custom.js - более новая версия бибилиотеки kendo для фильтров по словарям            <br>            Замечания: для поддержки хранимых/отображаемых значений к полям с такими форматами как combobox/autocomplete при определении их колонок в настройках kendo дописывается .displayValue, это сопоставление делается через функции dotValue. Без этого не работала раньше нормально сортировка и группировка в kendo. C введением серверных/сортировок, но отказ потребует хорошего тестирования, в частности инлайн-редактирование, сортировки, группировки и форматы полей.<br>            Сервисы <br>                GridFiltersView - получение настроек полей фильтров<br>                IpInlineGridEditors (ip-saas\WebContent\src\inline-editors-view) - получение компонентов для инлайн редактирования<br>            Настройки грида<br>                GridDefinition.js - основные настройки колонок<br>                ip-saas\WebContent\src\list-tree-grid - функции общие для LIST и TREE_LIST (возможно сюда можно вынести больше функций)<br>                    dotValue - для правильного отображение полей с displayValue наименование колонок у kendo и сервера может отличаться,  используется для их связи<br>                    grid-functions - функции форматирования данных и получения настроек сортировки<br>                KendoDataSourceSchema.js - описание связи между плоской структурой данных от сервера и древоводиной, которая используется в kendo<br>                KendoDataSourceTransport.js - описание связи между методами datasource от query-component и методами datasource от kendo<br>            Настройки функций обратного вызова <br>                idea-grid.js <br>                    - callbackOptions.refreshData - обновить данные виджета <br>                    - callbackOptions.refreshFull - построить виджет заново<br>                    - callbackOptions.destroyWidget - уничтожить виджет<br>                    - callbackOptions.getForm - получить данные формы<br>            Вспомогательные функции  <br>                grid-functions.js - общие функции преобразованиея данных между серверным и kendo форматом<br>                grid-form-functions.js - функции преобразованиея форм между серверным и kendo форматом<br>            Настройки кастомизации<br>                KendoGridExcelExport.js - функции добавляющие кастомизацию в экспортируемый Excel-файл<br>                GridCustomisations.js <br>                    - gridMenuCustomisation - перенос кнопки меню в правый верхний угол<br>                    - gridTdWhiteSpaceCustomisation - проставление класса grid-loading/grid-loaded при загрузке<br>                    - getColumnInitFunction - скрытие лишних полей из меню выбора колонок<br>                idea-grid.js (рекомендуется постепенно вынести в отдельные функции и файлы)<br>                    - refreshData - внутри groupsToToggle указан список текущих свернутых групп, которые нужно свернтуть после обновления, а в selectedRowsList список выделенных строк, которые нужно снова выделить<br>                    - onDataBound <br>                        = привязка dataSource.onFocus к двойному клику<br>                        = убирание сортировки по колонке при наличии группы по ней для синхронизации направлений сортировки и группировки<br>                    - init <br>                        = переменная command содержит кнопки инлайн редактирования, для которых создается отдельная колонка, ширина которой должна учитываться при построении и ресайзе компонента таблицы <br>                        = columnsToLoad - список загружаемых в данный момент колонок<br>                        = scope.kendoOptions.toolbar - настройки и кастомизация кнопокок на панели инструментов<br>                    - getKendoGrid().bind('edit', function (options) {... - передача значений по умолчанию при создании записи через инлайн редактирование<br>                    - if (scope.queryOuterOptions.adaptiveHeight) { ... - реализация сжатия по высоте<br>                    - scope.callbackOptions.setWidth = (currentWidth, force) => { ... - реализация сжатия по ширине процентных величин у колонок<br>                    - scope.bindCollapseExpand = function () { ... - реализация кнопки "Свернуть/Развернуть все"<br>                    - scope.initButtonSelectAll = function () { ... - реализация кнопки "Выделить/очистить все" <br>                KendoDataSourceTransport.js - убирание сортировки по колонке при наличии группы по ней для синхронизации направлений сортировки и группировки<br><br>        <strong>IpTreeGridView </strong>ip-saas\WebContent\src\tree-grid-view - древоводиный список используется для ViewType = TREE_LIST<br>            Основной файл: ip-saas\WebContent\src\grid-view\tree-grid.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaTreeGridView использует http://demos.telerik.com/kendo-ui/treelist/index<br>            Замечания: для поддержки хранимых/отображаемых значений к полям с такими форматами как combobox/autocomplete при определении их колонок в настройках kendo дописывается .displayValue, это сопоставление делается через функции dotValue. Без этого не работала раньше нормально сортировка и группировка в kendo. C введением серверных/сортировок, но отказ потребует хорошего тестирования, в частности инлайн-редактирование, сортировки, группировки и форматы полей.<br>            Настройки три-грида<br>                options-service.js - основные настройки колонок, настройки добавляющие кастомизацию в экспортируемый Excel-файл<br>                getToolbar.js - настройки toolbar (аналогичный файл рекомедуется и для IdeaGridView)<br>                data-source.js  - описание связи между плоской структурой данных от сервера и древоводиной, которая используется в kendo<br>                                - описание связи между методами datasource от query-component и методами datasource от kendo<br>            Вспомогательные функции<br>                tree-grid-form-functions.js - функции преобразованиея форм между серверным и kendo форматом<br>            Настройки функций обратного вызова <br>                tree-grid.js<br>                    - callbackOptions.refreshData - обновить данные виджета <br>                    - callbackOptions.refreshFull - построить виджет заново<br>                    - callbackOptions.destroyWidget - уничтожить виджет<br>                    - callbackOptions.getForm - получить данные формы<br>                    - callbackOptions.setHeight - отреагировать на изменение высоты<br>            Настройки кастомизации<br>                dom-customization.js<br>                    - applyColumnMenuCustomization - перенос кнопки меню в правый верхний угол<br>                    - applyNoDataCustomization - вывод тела грида при отстуствии записей<br>                    - applyDbClickCustomization - привязка dataSource.onFocus к двойному клику<br>                tree-grid.js<br>                    swapSettings - обработка перехода от пользовательских настроек к дефолтным<br>                    saveSettings - обработка сохранения настроек<br>        <br>        <strong>IpIdeaChartView </strong>ip-saas\WebContent\src\chart-view - компонент построения графиков для ViewType = BAR_CHART, PIE_CHART, MULTI_PLOT<br>            Основной файл: ip-saas\WebContent\src\chart-view\idea-chart.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaChartView использует angular-nvd3 для BAR_CHART и PIE_CHART и с3.js для MULTI_PLOT<br>                nv-utils-fix.js - фикс для библиотеки nvd3<br>            Настройки графиков <br>                idea-chart.js<br>                    - fieldsToChartFields - преобразорвание полей от серверного формата<br>                    - toC3ChartData - преобразорвание данных от серверного формата в формата с3.js<br>            Вспомогательные функции<br>                chart-convert.js - функции преобразованиея форм между серверным и kendo форматом, функции округления<br>            Настройки функций обратного вызова <br>                idea-chart.js<br>                    - callbackOptions.refreshData - обновить данные виджета <br>                    - callbackOptions.refreshFull - построить виджет заново<br>                    - callbackOptions.destroyWidget - уничтожить виджет<br>            Настройки кастомизации<br>                chart-export.js - функции добавляющие кастомизацию в экспортируемый PDF/PNG-файл<br>        <br>        <strong>IpSchedulerView </strong>ip-saas\WebContent\src\scheduler-view - компонент календаря для ViewType = SCHEDULER<br>            Основной файл: ip-saas\WebContent\src\scheduler-view\scheduler.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaSchedulerView использует http://demos.telerik.com/kendo-ui/scheduler/index<br>            Настройки компонента планировщика задач<br>                options-service.js <br>                    - schedulerOptionsServiceFunc - основные настройки планировщика<br>                    - workDayPairViewService и workWeekPairViewService - получение рабочих часов и дней для раскраски планировщика<br>                    - groupsOptionServiceFunc - получение списка групп, которые нужно показывать<br>                data-source.js  - описание связи между структурой данных от сервера и той, которая используется в kendo<br>                                - описание связи между методами datasource от query-component и методами datasource от kendo<br>            Настройки функций обратного вызова <br>                scheduler.js<br>                    - callbackOptions.refreshData - обновить данные виджета <br>                    - callbackOptions.refreshFull - построить виджет заново<br>                    - callbackOptions.destroyWidget - уничтожить виджет<br>                    - callbackOptions.setHeight - отреагировать на изменение высоты            <br>            Настройки кастомизации<br>                dom-customization.js<br>                    - applyEditCreateCustomisation - меню при создании через правую кнопку мыши и редактирование по двойному клику<br>                    - applyWorkDaysCustomisation - скрытие нерабочих дней<br>                    - applyGroupsHierarchyCustomisation - скрытие групп, не указанных в списке групп<br>                scheduler.js<br>                    displayMode - показ всех событий или только своих<br><br>        <strong>IpGanttView </strong>ip-saas\WebContent\src\gantt-view - компонент диаграммы Гантта для ViewType = GANTT<br>            Основной файл: ip-saas\WebContent\src\gantt-view\idea-gantt.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaGanttView использует https://github.com/robicch/jQueryGantt<br>            Сервисы <br>                IpInlineGridEditors (ip-saas\WebContent\src\inline-editors-view) - получение компонентов для инлайн редактирования<br>            Настройки диаграммы Гантта <br>                gantt-functions.js<br>                    - listToPlainTree - преобразорвание данных от серверного формата в формата с3.js<br>                    - toClientFormat и toServerFormat - преобразорвание отдельных записей от серверного формата и обратно<br>            Настройки функций обратного вызова <br>                idea-gantt.js<br>                    - callbackOptions.refreshData - обновить данные виджета <br>                    - callbackOptions.refreshFull - построить виджет заново<br>                    - callbackOptions.destroyWidget - уничтожить виджет<br>                    - callbackOptions.setHeight - отреагировать на изменение высоты<br>            Настройки кастомизация<br>                В диаграмме Гантта изначально не было реакции на смену отдельного события, они все могли сохранятся только вместе, необходимо отслеживать различия между разными транзакциями и сохранять их по отдельности<br>                idea-gantt.js<br>                    - refreshData если значения изменились после вставки в диаграмму (такое возможно, если отступы не соответствовали связям, например при генерации на сервере), то запускаем обновление и показываем прогресс бар<br>                    - GanttMaster.prototype.endTransaction - добавляем реакцию на смену события<br>                gantt-functions.js<br>                    - getDiffFields - получить поля которыми отличаются события<br>                    - getChangedTasks - получитm отличающиеся события<br>                В диаграмме Гантта изначально не было выбора способа инлайн редактирования это исправляется настройкой класса GridEditor<br>                ideaGanttGridEditor.js<br>                    - fillEmptyLines, addTask, bindRowInputEvents - заполнение строк (пустых и с событиямми), чтобы клик по ним учитывал кастомный редактор<br>                    - getTaskTemplates - обертка для работы редакторов от idea-grid<br>        IpCommentsView ip-saas\WebContent\src\comments-view - компонент новостей для ViewType = NEWS_FEED, также испольуется для показа комментариев на форме<br>            Основной файл: ip-saas\WebContent\src\gantt-view\comments-view.js<br>            Компоненты и библиотеки<br>                Основной компонент для работы - ideaCommentsView, не использует дополнительных библиотек, в режиме комментариев - использует редактор http://demos.telerik.com/kendo-ui/editor/index<br>                when-scrolled - реакция на скролинг, подгрузка "по требованию" <br><br>            <br><strong>IpModalView  </strong>ip-saas\WebContent\src\modal-view - модуль отвечающий за представлений формы одной записи(типа DETAILS) в модальном окне, а также свящанных таблиц и представлений "списочного типа" также в модальном окне. На уровне ангуляра реализован как сервис ModalView, создающий моальное окно с заданными данными поверх текущего представления.<br>Для самого окна испольщуется контроллер ModalInstanceCtrlView. Основным компонентом для отображения формы одной записи является компонент IpFormGridster (новые формы с поддержкой высот) и IpFormView (старые формы). Старый скоро будет снят с поддержки, так что далее  рассмотривается только IpFormGridster.<br>    Методы открытия модальных форм<br>        = edit(viewId, rowId) - открыть у viewId на редактирование строку под номером rowId<br>        = editByRow(viewId, fieldName, fieldValue) - открыть у viewId на редактирование строку с полем fieldName равным fieldValue<br>        = createBy(viewId, sourceParametersObject, targetParametersObject, envVars) - открыть окно на создание записи у viewId из записи со значениями sourceParametersObject, с переменными окружения envVars, добавив к дефолтным значениям полей targetParametersObject<br>        = create(viewId, parametersObject) - открыть окно на создание записи у viewId, добавив к дефолтным значениям полей parametersObject<br>        = remove(viewId, rowId) - открыть у viewId на удаление строку с полем fieldName равным fieldValue // устаревшее, нужно использовать edit<br>        = query(viewId, parametersObject) - открыть табличный viewId, добавив parametersObject к парметрам поиска<br>        = search(entityTypeId) - открыть табличный viewId, добавив parametersObject к парметрам поиска // устаревшее, нужно использовать query<br>        = link(viewId, sourceParametersObject, targetParametersObject, envVars) - открыть табличный viewId для отмечания в нем полей для добавления как виртульные к текущей записи со значениями sourceParametersObject, с переменными окружения envVars, добавив к дефолтным значениям полей targetParametersObject<br>    ModalInstanceCtrlView - обеспечивает получение данных от ViewData для формы одной записи, также реализует получение данных из формы одной записи или из формы поиска списочного представления при помощи реализации modal.getControllerData. Этот метод используется для получения значений с формы перед её закрытием. Например так работает настройка параметров отчета на дашбордах, которая также реализована через IpModalView.<br>    <strong>IpFormGridster </strong>ip-saas\WebContent\src\form-gridster - компонент отвечает за работу форм одной записи (view = DETAILS) Реализован как директива ideaFormGridster.<br>        Параметры:<br>            initData - начальные данные<br>            detailsOptions - серверные настройки View<br>            environmentOptions - настройки View от окружения<br>            callbackOptions - функции обрабтного вызова<br>                Обработка жизненного цикла<br>                    destroyWidget - действия при закрытии формы<br>                Обработка изменения данных<br>                    getData - получение значений формы<br>                    setData - установка значений формы<br>                    onDataChanged - вызывается при смене данных, например при нажатие на кнопку "Показать" у параметров отчета<br>                Обработка сжатия по высоте (environmentOptions.adaptiveHeight === true)<br>                    getOpenHeight - передача высоты в открытом виде<br>                    getClosedHeight - передача высоты в закрытом виде<br>                    setHeight - реакгировать на смену высоты<br>                    onSizeChanged - вызывается при смене высоты, например при закрытии вкладки<br>            withEditor - включать ли редактор форм<br>            provider - функция обновления<br>        Основный элемент formManager, который располагает на форме заголовок (idea-form-header.html) и отдельный поля idea-form-field.html.<br>        Поля строятся в компоненте IpFieldView<br>        Строится на основе компонента formManager, в который передаются настройки<br>            formManagerOptions - настройки форм и самого мененджера<br>            header - настройки заголовка<br>            Настройки для передачи в компонент отдельного поля<br>                environmentOption - внешние настройки формы<br>                formData, formType - значения формы<br>                data - значения данных<br>                fields - значения полей<br>                viewId - имя view<br>                process - коллбэки нажатия на кнопку формы и изменения размера виджета<br>        <br>        Обработка нажатия на кнопку происходит в processButton и uiRuleFunctions, обработка правил в uiRuleFunctions, заголовок настраивается в header и передается в formManager<br>        Нажатия на кнопки реализуются внутри формы в методе processButton.<br>        Обработка нажатия на кнопку внутри формы включает в себя следующие действия<br>            1) Выполнение stopPropagation на случай, если нажатие призошло на кнопку внутри заголовка вкладки.<br>            2) Обновление в данных поля используемого редактором заголовка, если заголовок редактируемый.<br>            3) Установка списка возможных функций (functionsToExec), которые должны выполняться после отработки сценариев обработки кнопок.<br>            4) Установка формы в режим ожидания (header.waitingForServer, waitingForServer, css('cursor', 'wait')).<br>            5) Определение нужно ли делать обновление формы данными от сервера (updateBeforeRefreshPromise) и ожидание этого обновления.<br>            Обновление делается вызовом refresh с объектом текущей кнопки button.<br>            6) Внутри метода refresh делается обнвление данных данными с сервера и вызывается обработка правил (uiRuleFunctions) с параметром serverRefresh = true. Если обновление не нужно идем к пункту 9.<br>            7) Внутри обработчика правил при наличии serverRefresh = true делается сравнение данных пользователя из prevRecord и данных от сервера в record, после чего они мерджаться. После этого выполняются клиентские правила с нажатой в начале кнопкой в параметрах контекста<br>            8) Если внутри правил не было вызвано ruleResults.breakExecution, до переходим к выполению сценария, указанного в кнопке.<br>            9) Сценарии нажатия на кнопку описываются в сервисе ip-saas\WebContent\src\ui-rules-view\scenario.js и представляют собой последовательное выполнение правил из сервиса ip-saas\WebContent\src\ui-rules-view\client-rule.js. Элементы сценария описаны как Promise, со значением в виде объекта функций которой нужно применить функции после окончания обработки сценария. При наличии ошибки выкидается объект ошибки и вызов функции alert для отображения пользователю. Далее рассматривается стандартный сценарий обновления (Scenarios.crud) <br>            10) Вызываем ClientRuleView.validateInput для проверки валидности формы<br>            11) Вызываем ClientRuleView.processCrud для отправки на сервер валидной формы<br>            12) Вызываем ClientRuleView.processResponse для обработки результата от сервера обновляем необходимы данный (data) и метаданные от сервера (buttons, forms, rules)<br>            13) Формируем функции для вызова внутри формы, заканчиваем сценарий.<br>            14) Внутри processButton вызываем функции из списка functionsToExec в зависимости от того, что вернул Scenarios[scenarioName]<br><br><br><br>    <strong>IpFormManager </strong>ip-saas\WebContent\src\form-manager - компонент, отвечающий за отображение и редактирование форм одной записи и дашбордов. Для его правильной работы ему требуются помимо стандартных настроек ссыли на шаблон заголовка и шаблон отдельного поля<br>        Библиотеки <br>            ip-saas\WebContent\vendor\angular-gridster.min<br><br>        Настройки options<br>            onSetWidgetHeight - вызывается дочерним компонентом, если он сам меняет свою высоту, например грид при малом числе записей<br>            withEditor - режим редактирования<br>            isSectionExist - функция для выяснения существует ли секция в памяти (определяется в form-gridster)<br>            saveForm - функция для сохранения формы (определяется в form-gridster)<br>            focusField - функция для действий при фокусировки на компонент (определяется в form-gridster)<br>            resizeField - функция для действий при ресайзе компонента (определяется в form-gridster)<br>            isRowVisible - функция для выяснения видима ли строка (определяется в form-gridster)<br>            fieldComponentUrl - шаблон компонента поля<br>            headerUrl - шаблон компонента заголовка<br>            gridsterOptions - настройки сетки гридстера<br>        <br>    <strong>IpFieldView </strong>ip-saas\WebContent\src\field-view - компонент, отвечающий за отображение различных полей на форме одной записи по их настройкам, переинициализируется при смене настроек<br>        Настройки<br>            viewId - название viewId формы<br>            element описание element'a получаемы из  ip-saas\WebContent\src\convert\form-functions.js getWidget<br>            data - данные формы, которые слушаются внутри IpFormGridster и при изменении которых вызывается обработка UI-rule<br>            dashboardData - данные дашборда<br>            fields - описание полей<br>            form - описание формы<br>            formType - описание типа формы<br>            isPopup - описание в попапе ли мы<br>            process, processButton - коллбэки для кнопок и смены размера<br>        Возможные компоненты <br>            input - стандартное поле ввода строки, чисел, пароля<br>            float-component (ip-saas\WebContent\src\float-editor) - редактор дробных чисел<br>            button - кнопка срабатывающая как кнопка в заголовке<br>            checkbox - галка true/false<br>            html-label-container - метка в html<br>            idea-time, idea-datetime (ip-saas\WebContent\src\idea-datetime) - отображение даты и времени<br>            textarea - стандартное поле ввода текста <br>            richtext (ip-saas\WebContent\src\text-editor) - редактор richtext<br>            code (ip-saas\WebContent\src\code-editor) - редактор кода<br>            select-component (ip-saas\WebContent\src\select-view) - поле типа combobox/autocomplete для  ввода словарных занчений, <br>                использует ip-saas\WebContent\vendor\select2.js<br>            checkbox-list-component (ip-saas\WebContent\src\checkbox-list-component) - массив галок true/false<br>            idea-attachment (ip-saas\WebContent\src\idea-attachment) - одиночное вложение файла или картинка аватара, использует серви FileUploader из библиотеки ip-saas\WebContent\vendor\angular-file-upload.min.js<br>            idea-multiattachment (ip-saas\WebContent\src\idea-multiattachment) - вложение нескольких файлов, использует компонент http://demos.telerik.com/kendo-ui/upload/index<br>            idea-comments-view (ip-saas\WebContent\src\comments-view) - виджет комментариев<br>            query-component - IpQueryComponent<br>    IpUiRuleView (ip-saas\WebContent\src\ui-rules-view) - компонент обработки клиентских правил и сценарие нажатий на кнопку.<br>    Основной сервис - IpUiRuleView (ip-saas\WebContent\src\ui-rules-view\ui-rule-engine.js)<br>        Полученные с сервера правила сортируются и обрабатываются при каждом вызове функции полученной от getOnChangeFunction<br>        При выполении правил текущие значения формы в них передается как record.<br>        При этом также производится сохранение prevRecord - запись до предыдущего изменения и initialRecord - начальные значения формы, которые также доступны в правилах. Также в ui-rule-engine.js обрабатываются значения пришедшие от сервера при обновлении записи перед нажатием на кнопку.<br>        Кроме record, prevRecord, oldRecord, initialRecord в правилах доступны специальные сервисы:<br>            QueryUtils - сервис IpQueryUtilsView (query-utils.js) - получение значений из таблицы от сервера<br>            ContextUtils - сервис IpContextUtilsView - получение <br>            alerts - сервис вывода сообщений и модальных всплывающих окон<br>        Обработка нажатия на кнопки происходит в сервисе ip-saas\WebContent\src\ui-rules-view\scenario.js и представляют собой последовательное выполнение правил из сервиса ip-saas\WebContent\src\ui-rules-view\client-rule.js. Подробное описание находится в справке IpFormGridster.<br>        <br><br><strong>IpDashboardView </strong>(ip-saas\WebContent\src\dashboard-view) - модуль отвечающий за показ дашбордов ViewType = DASHBOARD<br>Основой функционал модуля сосредоточен в компоненте IpDashboardComponent (ip-saas\WebContent\src\dashboard-component)<br>    IpDashboardComponent - компонент реализующий вывод входящих в дашборд отчетов по средством IpFormManager. В самом реализована смена параметров дашборда и настройка самого дашборда (ctrl.formManager),  полей (ctrl.elements) и заголовка (ctrl.header) для IpFormManager<br><br><strong>FormEditorPageView </strong>(ip-saas\WebContent\src\form-editor-view) - модуль отвечающий за показ редактора форм одной записи и дашбордов.<br>    Функционал модуля реализован в компоненте IpFormManager<br>        - toggleEditorMode - переключение с предпросмотра на режим редактирования<br>        Компонент form-editor-panel реализует левую панель с которой можно перетаскивать отступы и потенциально любые другие виду полей. ОБработка переноса осуществляется в onDropComplete<br>        moveSectionDown,moveSectionUp, removeSection, addEmptySection - работа с секциями<br><br><strong>IpSearchView </strong>- компонент отвечающий за показ глобального поиска и поиска по справочнику. Для своей работы использует компонет IpFormGridster, директиву ip-saas\WebContent\src\resizer-view (для панельки слева), а так же<br>    SearchParametersParseServiceView - для парсинга параметров<br>    SearchViewService - для получения данных <br>    searchCollapseView - директива для сворачивания дерева слева<br>    SearchController - для настройки работы, в первую очередь для синхронизации тегов и параметров поиска <br>    <br>IpWorkflow - компонент отвечающий за работу редактора workflow (ip-saas\WebContent\src\workflow) <br>    Основная библиотека - JointJS<br>        WorkFlowController - обработка загрузки сохранения WorkFlow<br>        ideaWorkflowDirective - обработка создания элементов и связывания их связями, обработка кликов по элементам<br><br><br>Компонеты <strong>IdeaHome</strong>, <strong>IdeaLogin</strong>, <strong>IpConfirmation</strong> и <strong>IpPasswordRestore</strong> используются для регистрации и обработки приглашения новых пользователей<br><br>Важные сервисы и функции используемые приложением<br><strong>IpInlineGridEditors </strong>ip-saas\WebContent\src\inline-editors-view сервис используется для реализации инлайн редакторов, которые используются в IdeaGridView и IdeaGanttView<br>    inline-grid-editors.js реализует функцию InlineGridEditorsFunction, которая выдает один из редакторов на оснавании widget`a переданного в parameters<br>    Тип виджета при этом определяется по значению поля kendo в объекте возвращаемом функцией getWidget из ip-saas\WebContent\src\convert\form-functions<br>    Сами виджеты строятся на по следующему принципу: <br>        Получаем параметры на основе widget выбираем одну из функций от container - к чему прикреплять виджет и options - значения редактируемой строки, поля, формат и т.д.<br>        Rогда функция вызывается она создает виджет на основе и options и parameters, передает ему значение от options.model[options.field] и вешает реакцию на изменение, которая меняет options.model[options.field]<br>        Tсли виджет реализован как jQuery-плагин, то он прикрепляется как angular.element('<input .....>').appendTo(container).pluginName(....), если используется директива ангуляра, то она компилируется el = $compile(angularTpl)(scope), el.bind('$destroy',  () => scope.$destroy() ), el.appendTo(container)<br>        Если используется специиальный тип редактора complex, то он сначала берет свой FielfdFormat из поля, options.model[fieldName + '_FORMAT'], потом получает описание формата с сервера, а потом по нему строит реальный формат.<br><br><strong>IpConvert </strong>ip-saas\WebContent\src\convert  для ранее написаного кода, использующего FlyData библиотека создает сервис IpConvert, в новом коде из нее просто импортируются функции<br>    convert-utils.js - основные функции конвертации, описаны как для отдельных полей разных типов (combobox, number, float, primitiveArray, datetime, date, time), так и сразу всей записи (entity)<br>    Основные форматы между которыми идет конвертация <br>        TransitionFormat - формат в котором данные передаются от сервера <br>        ClientFormat - формат в котором данные показываются пользователю<br>        JS - собственно к и из которого и происходит конвертация<br>        PackFormat - формат для сохранение данных в строке вмести с их типом, используется при сохранении данных в URL<br><br>    form-functions - основные функции работы с элементами и старыми формами<br>        getFormElement - получить элемент из серверных field для формата idea-field<br>        getWidget - соответствие между стилем формата поля от сервера и widget на клиенте<br>        getFullFormForDirectives - получение старых форм, в новых от них используется только поле plain, остальное можно будет удалить при отказе от старых форм  <br>IpConnection ip-saas\WebContent\src\connection - модуль изолирует работу с сервером по средством сервиса ViewData и класса View и производит первичную конвертацию данных (не зависящую от формата и настроек конкретного представления)  по средством класса Response<br>    view-data.js реализует класс View, который реализует построитель запросов к серверу, и изолирует в себе конвертацию данных перед отправкой на сервер<br>    view-response.js реализует класс Response, который производит первичную конвертацию данных (не зависящую от формата и настроек конкретного представления) и строит по серверным данным следующие объекты:<br>        data() - собственно данные от сервера в формате для обработки, внутри себе использует _getRowData ,_getListData, _getCalendarData для получения данных в зависимости от текущего ViewType<br>        form() - получение формы, новой или старой, в зависимости от той, какая пришла с сервера<br>        messages() - сообщений от сервера<br>        pkFieldName() - имя поля с ключом у текущего View<br>        fields() - получение полей для текущего View<br>        getDetailsWidget() - настройки виджета для ViewType = DETAILS<br>        getQueryWidget() - настройки виджета для ViewType ViewType = LIST, SIMPLE_LIST, TREE_LIST, BAR_CHART, PIE_CHART, MULTI_PLOT, PIVOT_TABLE, SCHEDULER, GANTT, NEWS_FEED.<br>        getFormWidget()  - настройки виджета при показе в редакторе форм<br>        getSearchWidget() - настройки виджета для показа в глобальном поиске или справочнике<br>        getDashboardOptions() - настройки для виджета дашборда </body></html>