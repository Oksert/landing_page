<h2 id="3c623e3c693ed092d0b2d0b5d0b4d0b5d0bdd0b8d0b53c2f693e3c2f623e"><strong><em>Введение</em></strong></h2><div>Для обработки ошибок в различных языках программирования традиционно применяется два подхода:</div><div><ul><li><span style="">Проверка кодов возврата (C, Fortran, часто C++)</span></li><li><span style="">Обработка исключений (Java, C#, Python, Ruby и т. д.)</span></li></ul></div><div><br /></div><div>Проверка кодов возврата является хронологически более старым способом и широко применяется в таких языках как C, Fortran, первые версии C++ (стандарты Google и сейчас их запрещают http://google-styleguide.googlecode.com/svn/trunk/cppguide.xml#Exceptions). После каждого вызова проверяется, что указатель не null, что возвращенное значение больше нуля и т.д. По этой же причине функция main в С/С++ возвращает int, а в Java - void, хотя в остальном их сигнатура совпадает.</div><div>Обработка исключений - это более новый механизм, заключающийся в том, что участок кода подверженный ошибке обозначается специальным образом и, в случае возникновения ошибки вызывается определенный обработчик.</div><div><br /></div><div><h2 id="3c623e3c693ed098d181d0bad0bbd18ed187d0b5d0bdd0b8d18f20d0b2206a6176613c2f693e3c2f623e"><strong><em>Исключения в Java</em></strong></h2></div><h3 id="3c623ed09ed181d0bdd0bed0b2d18b2e20d091d0bbd0bed0bad0b82074727920d0b82063617463683c2f623e"><strong>Основы. Блоки try и catch</strong></h3><div>В Java обработка исключений в простейшем случае выглядит так:</div><div><pre style="line-height:normal;">int i = (new java.util.Random()).nextInt(2)<span style="color:#806030;">;</span>
try<span style="color:#806030;">{</span> <span style="color:#c34e00;">//Этот код вызовет ошибку на половине запусков</span>
	<span style="color:#800040;">int</span> a <span style="color:#806030;">=</span> <span style="color:#c00000;">1</span><span style="color:#806030;">/</span>i<span style="color:#806030;">;</span>
	<span style="color:#800040;">System</span><span style="color:#806030;">.</span>out<span style="color:#806030;">.</span>println<span style="color:#806030;">(</span><span style="color:#e60000;">"You are lucky, bastard"</span><span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span>
catch(ArithmeticException ae)<span style="color:#806030;">{</span>
	<span style="color:#800040;">System</span><span style="color:#806030;">.</span>out<span style="color:#806030;">.</span>println<span style="color:#806030;">(</span><span style="color:#e60000;">"Ha-ha, looser"</span><span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span></pre></div><div>Подозрительный код в данном случае - это целочисленное деление на ноль, этот код обрамляется специальной &nbsp;конструкцией try {...}, за которой следует описание обработчика ошибок - catch(...){}.</div><div>Обратите внимание на скобки после блока catch - в них записан класс перехватываемых исключений. Все исключения, которые возникают в программах на Java, описываются как объект некоторого класса исключений. Таким образом блок catch обрабатывает не все, а только строго положенные ему исключительные ситуации. Вслед за именем класса исключения указывается локальное имя объекта исключения, через которое можно к этому исключению обратиться. Например, в предыдущем примере мы могли написать так:</div><div><div><pre style="line-height:normal;">catch(ArithmeticException ae)<span style="color:#806030;">{</span>
	<span style="color:#800040;">System</span><span style="color:#806030;">.</span>out<span style="color:#806030;">.</span>println<span style="color:#806030;">(</span>ae<span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span></pre></div></div><div>чтобы получить информацию об объекте исключения</div><div><pre style="color:#000020;line-height:normal;">java.lang.ArithmeticException: / by zero</pre></div><div>Чтобы получить более подробную информацию об ошибке воспользуемся методом getStackTrace():</div><div><pre style="line-height:normal;">catch(ArithmeticException ae)<span style="color:#806030;">{</span>
    <span style="color:#400000;font-weight:bold;">for</span> <span style="color:#806030;">(</span>StackTraceElement element<span style="color:#806030;">:</span> ae<span style="color:#806030;">.</span>getStackTrace<span style="color:#806030;">(</span><span style="color:#806030;">)</span><span style="color:#806030;">)</span>
        <span style="color:#800040;">System</span><span style="color:#806030;">.</span>out<span style="color:#806030;">.</span>println<span style="color:#806030;">(</span>element<span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span></pre></div><div><span style="">вывод:</span></div><div><pre style="color:#000020;line-height:normal;">Test.main(Test.java:12)</pre></div><div><br /></div><div>Поскольку вывод информации об ошибке это довольно частое действие для него предусмотрен специальный метод printStackTrace() (по-умолчанию информация печатается в стандартный поток ошибок):</div><div><br /></div><div><div><pre style="line-height:normal;">catch(ArithmeticException ae)<span style="color:#806030;">{</span>
	ae<span style="color:#806030;">.</span>printStackTrace<span style="color:#806030;">(</span><span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span></pre></div></div><div><span style="">вывод:</span><span class="Apple-tab-span" style="white-space:pre;"> </span>
</div><div><pre style="color:#000020;line-height:normal;">java.lang.ArithmeticException: / by zero
        at Test.main(Test.java:12)</pre></div><div><span style="">Теперь, когда вы знаете базовую информацию об исключениях в Java, обсудим, что делать после обработки ошибки.</span></div><div><div></div></div><div><br /></div><h3 id="3c623ed091d0bbd0bed0ba2066696e616c6c793c2f623e"><strong>Блок finally</strong></h3><div>Часто при обработке ошибок возникает ситуация, когда какое-то действие должно быть обязательно выполнено после окончания работы. При этом неважно произошла ошибка или нет. Чаще всего такие действия связаны с освобождением внешних ресурсов, например, с закрытием файла или соединения с базой данных. Для таких действий собственно и приспособлен блок finally: код заключенный в него будет выполнен после отработки соответствующего блока try, при этом не важно будет вызван блок catch или нет.</div><div><br /></div><div><pre style="line-height:normal;">try<span style="color:#806030;">{</span>
&hellip;&hellip; <span style="color:#c34e00;">//Работа с базой данных</span>
<span style="color:#806030;">}</span>
catch(SqlException e)<span style="color:#806030;">{</span>
&hellip;<span style="color:#806030;">.</span><span style="color:#806030;">.</span> <span style="color:#c34e00;">//Обработка ошибки</span>
<span style="color:#806030;">}</span>
finally<span style="color:#806030;">{</span>
&hellip;<span style="color:#806030;">.</span><span style="color:#806030;">.</span> <span style="color:#c34e00;">//Закрытие соединения</span>
<span style="color:#806030;">}</span></pre></div><div><br /></div><div><ul><li><span style="">если исключение было перехвачено, последовательность выполнения кода будет такой:</span></li><ul><li><span style="">блок try до исключения&nbsp;</span></li><li><span style="">обработчик исключений в блоке catch&nbsp;</span></li><li><span style="">&nbsp;блок finally</span></li></ul><li><span style="">если исключение не было перехвачено, то :</span></li><ul><li><span style="">блок try до исключения&nbsp;</span></li><li><span style="">блок finally</span></li></ul><li><span style="">и при успешном завершении блока try последовательность действий будет такой:</span></li><ul><li><span style="">блок try до конца</span></li><li><span style="">блок finally</span></li></ul></ul></div><div><br /></div><h3 id="3c623ed09dd0b5d0bfd0b5d180d0b5d185d0b2d0b0d187d0b5d0bdd0bdd18bd0b520d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d18f3c2f623e"><strong>Неперехваченные исключения</strong></h3><div>В прошлом пункте мы коснулись ситуации, когда исключение не перехватывается. Что же произойдет, если порожденное в программе исключение не будет перехвачено? Если внутри какого-то метода произошло исключение, которое не было перехвачено, то исключение будет передано &nbsp;методу вызывавшему текущий метод, и так далее, пока программа не дойдет до последнего метода main. Если исключение не перехватывается в методе main, то программа аварийно завершается:</div><div><pre style="line-height:normal;"><span style="color:#400000;font-weight:bold;">public</span> <span style="color:#400000;font-weight:bold;">static</span> void main (String[] args)<span style="color:#806030;">{</span>
	<span style="color:#800040;">int</span> i <span style="color:#806030;">=</span> <span style="color:#806030;">(</span><span style="color:#400000;font-weight:bold;">new</span> java<span style="color:#806030;">.</span>util<span style="color:#806030;">.</span><span style="color:#800040;">Random</span><span style="color:#806030;">(</span><span style="color:#806030;">)</span><span style="color:#806030;">)</span><span style="color:#806030;">.</span>nextInt<span style="color:#806030;">(</span><span style="color:#c00000;">2</span><span style="color:#806030;">)</span><span style="color:#806030;">;</span>
	<span style="color:#800040;">int</span> a <span style="color:#806030;">=</span> <span style="color:#c00000;">1</span><span style="color:#806030;">/</span>i<span style="color:#806030;">;</span>
	<span style="color:#800040;">System</span><span style="color:#806030;">.</span>out<span style="color:#806030;">.</span>println<span style="color:#806030;">(</span><span style="color:#e60000;">"You are lucky, bastard"</span><span style="color:#806030;">)</span><span style="color:#806030;">;</span>
<span style="color:#806030;">}</span></pre></div><div>вывод:</div><div><pre style="color:#000020;line-height:normal;">Exception in thread "main" java.lang.ArithmeticException: / by zero
        at Test.main(Test.java:11)</pre></div><div><strong><br /></strong></div><h3 id="3c623ed092d181d0b520d0bbd0b820d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d18f20d0bdd183d0b6d0bdd0be20d0bfd0b5d180d0b5d185d0b2d0b0d182d18bd0b2d0b0d182d18c3f3c2f623e"><strong>Все ли исключения нужно перехватывать?</strong></h3><div><div>Если в методе может возникнуть наследник Exception, не являющийся <a class="wiki_link" href="/wiki/show/vsm2_1step/RuntimeException" title="RuntimeException">RuntimeException</a>, то метод обязан декларировать выбрасывания исключения:</div><div><pre style="color:#000020;line-height:normal;">void workingWithDB() <span style="color:#200080;font-weight:bold;">throws</span> SqlException<span style="color:#406080;">{</span>
  <span style="color:#200080;font-weight:bold;">try</span><span style="color:#406080;">{</span>
   &hellip;&hellip; <span style="color:#595979;">//Работа с базой данных</span>
   <span style="color:#406080;">}</span>
   <span style="color:#200080;font-weight:bold;">finally</span><span style="color:#406080;">{</span>
    &hellip;<span style="color:#308080;">.</span><span style="color:#308080;">.</span> <span style="color:#595979;">//Закрытие соединения</span>
   <span style="color:#406080;">}</span>
<span style="color:#406080;">}</span>
<br /></pre></div></div><div>Если посмотреть на иерархию исключений, то мы должны перехватывать все зеленое.</div><div><img src="https://www.assembla.com//spaces/vsm2_1step/documents/dxNog-ttSr44uqacwqjQYw/download/dxNog-ttSr44uqacwqjQYw" /><br /></div><div><br /></div><div><br /></div><div><div><strong><em><br /></em></strong></div><div><strong><em><br /></em></strong></div><div><strong><em><br /></em></strong></div><div><strong><em><br /></em></strong></div><h2 id="3c623e3c693ed0a1d0bed0b2d0b5d182d18b20d0bfd180d0b820d180d0b0d0b1d0bed182d0b520d18120d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d18fd0bcd0b83c2f693e3c2f623e"><strong><em>Советы при работе с исключениями</em></strong></h2><h3 id="3c623ed0a1d0bed0b7d0b4d0b0d0b2d0b0d0b9d182d0b520d181d0b2d0bed0b820d0bad0bbd0b0d181d181d18b20d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d0b920d18120d0bfd180d0b0d0b2d0b8d0bbd18cd0bdd18bd0bcd0b820d0b8d0bcd0b5d0bdd0b0d0bcd0b83c2f623e"><strong>Создавайте свои классы исключений с правильными именами</strong></h3></div><div>Для наиболее часто возникающих исключений старайтесь создавать свои классы исключений, так, что бы название уже содержало причину возникновения исключения</div><div><pre style="color:#000020;line-height:normal;"><span style="color:#200080;font-weight:bold;">class</span> WordContainsException <span style="color:#200080;font-weight:bold;">extends</span> Exception <span style="color:#406080;">{</span>
    <span style="color:#200080;font-weight:bold;">public</span> WordContainsException<span style="color:#308080;">(</span><span style="color:#308080;">)</span> <span style="color:#406080;">{</span><span style="color:#406080;">}</span> 
    <span style="color:#200080;font-weight:bold;">public</span> WordContainsException<span style="color:#308080;">(</span><span style="color:#6679aa;font-weight:bold;">String</span> message<span style="color:#308080;">)</span> <span style="color:#406080;">{</span>   
         <span style="color:#200080;font-weight:bold;">super</span><span style="color:#308080;">(</span>message<span style="color:#308080;">)</span><span style="color:#406080;">;</span> 
    <span style="color:#406080;">}</span> 
    <span style="color:#200080;font-weight:bold;">public</span> WordContainsException<span style="color:#308080;">(</span><span style="color:#6679aa;font-weight:bold;">Throwable</span> cause<span style="color:#308080;">)</span> <span style="color:#406080;">{</span>   
         <span style="color:#200080;font-weight:bold;">super</span><span style="color:#308080;">(</span>cause<span style="color:#308080;">)</span><span style="color:#406080;">;</span> 
    <span style="color:#406080;">}</span> 
<span style="color:#406080;">}</span> 
try <span style="color:#406080;">{</span> 
    <span style="color:#200080;font-weight:bold;">if</span><span style="color:#308080;">(</span>word<span style="color:#308080;">.</span>contains<span style="color:#308080;">(</span><span style="color:#1060b6;">" "</span><span style="color:#308080;">)</span><span style="color:#308080;">)</span> <span style="color:#406080;">{</span>
         <span style="color:#200080;font-weight:bold;">throw</span> <span style="color:#200080;font-weight:bold;">new</span> WordContainsException<span style="color:#308080;">(</span><span style="color:#1060b6;">" "</span><span style="color:#308080;">)</span><span style="color:#406080;">;</span> 
    <span style="color:#406080;">}</span> 
<span style="color:#406080;">}</span> catch(WordContainsException ex) <span style="color:#406080;">{</span> 
	<span style="color:#595979;">// обработка исключения </span>
<span style="color:#406080;">}</span></pre></div><div><h3 id="3c623ed09ad0bbd0b0d181d18120d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d18f20d0b4d0bed0bbd0b6d0b5d0bd20d181d0bed0bed182d0b2d0b5d182d181d182d0b2d0bed0b2d0b0d182d18c20d181d0bbd0bed18e2e3c2f623e"><strong>Класс исключения должен соответствовать слою.</strong></h3><div>Если мы передаем исключение наверх, то нужно это делать учитывая, слой приложения в которое исключение передается</div><div><pre style="color:#000020;line-height:normal;">try <span style="color:#406080;">{</span> 
     &hellip;&hellip; <span style="color:#595979;">//Работа с базой данных</span>
<span style="color:#406080;">}</span> catch(SqlException ex) <span style="color:#406080;">{</span> 
	&hellip;<span style="color:#308080;">.</span><span style="color:#595979;">//Обработка исключений</span>
	<span style="color:#200080;font-weight:bold;">throw</span> <span style="color:#200080;font-weight:bold;">new</span> DataModelException<span style="color:#308080;">(</span>ex<span style="color:#308080;">)</span><span style="color:#406080;">;</span>
     <span style="color:#595979;">// важно передать старое исключение новому</span>
<span style="color:#406080;">}</span>
finally<span style="color:#406080;">{</span>
    &hellip;<span style="color:#308080;">.</span><span style="color:#308080;">.</span> <span style="color:#595979;">//Закрытие соединения</span>
<span style="color:#406080;">}</span>
..... много кода....
try <span style="color:#406080;">{</span> 
     &hellip;&hellip; <span style="color:#595979;">//Работа с базой данных</span>
<span style="color:#406080;">}</span> catch(FileSystemException ex) <span style="color:#406080;">{</span> 
	&hellip;<span style="color:#308080;">.</span><span style="color:#595979;">//Обработка исключений</span>
	<span style="color:#200080;font-weight:bold;">throw</span> <span style="color:#200080;font-weight:bold;">new</span> DataModelException<span style="color:#308080;">(</span>ex<span style="color:#308080;">)</span><span style="color:#406080;">;</span>
     <span style="color:#595979;">// важно передать старое исключение новому</span>
<span style="color:#406080;">}</span>
finally<span style="color:#406080;">{</span>
    &hellip;<span style="color:#308080;">.</span><span style="color:#308080;">.</span> <span style="color:#595979;">//Закрытие соединения</span>
<span style="color:#406080;">}</span></pre></div></div><div><div><br /></div><h3 id="3c623ed092d18bd0b1d0b8d180d0b0d0b9d182d0b520d0bfd180d0b0d0b2d0b8d0bbd18cd0bdd0be20d0bcd0b5d0b6d0b4d1832072756e74696d65657863657074696f6e20d0b820657863657074696f6e3c2f623e"><strong>Выбирайте правильно между <a class="wiki_link" href="/wiki/show/vsm2_1step/RuntimeException" title="RuntimeException">RuntimeException</a> и Exception</strong></h3><div>Это правило напрямую следует из предыдущего. Иногда стоит заменить обрабатываемое исключение на необрабатываемое.</div><div>Слой доступа к базе ловит и обрабатывает 90% <a class="wiki_link" href="/wiki/show/vsm2_1step/SqlException" title="SqlException">SqlException</a>.&nbsp;</div><div>Остальные 10% процентов &ndash; порождают <a class="wiki_link" href="/wiki/show/vsm2_1step/DataModelException" title="DataModelException">DataModelException</a>.&nbsp;</div></div><blockquote style=""><div><div>=&gt; это плохо предсказуемые исключения</div></div><div><div>=&gt; наследуем <a class="wiki_link" href="/wiki/show/vsm2_1step/DataModelException" title="DataModelException">DataModelException</a> от <a class="wiki_link" href="/wiki/show/vsm2_1step/RuntimeException" title="RuntimeException">RuntimeException</a>
</div></div></blockquote><div><strong><br /></strong></div><div><div><em><strong>Кратко</strong></em></div><div><ul><li><strong><a class="wiki_link" href="/wiki/show/vsm2_1step/RuntimeException" title="RuntimeException">RuntimeException</a> </strong>&ndash; ошибка програмиста (null pointer, array out of bound)</li><li><strong>Exception </strong>&ndash; ошибка внешней системы (Sql, Http, File и т.д.)</li><li><strong>Код возврата</strong> &ndash; неверный ввод, являющийся нормой.</li></ul></div></div><div><br /></div><h3 id="d091d0bbd0bed0ba2066696e616c6c7920d0b820d0b8d181d0bad0bbd18ed187d0b5d0bdd0b8d18f">Блок finally и исключения</h3><div>Иногда исключение может возникнуть в блоке finally. В таких случаях приходится использовать вложенный обработчик.</div><div><pre style="color:#000020;line-height:normal;">try<span style="color:#406080;">{</span>
     oos <span style="color:#308080;">=</span> <span style="color:#200080;font-weight:bold;">new</span> <span style="color:#6679aa;font-weight:bold;">ObjectOutputStream</span><span style="color:#308080;">(</span>baos<span style="color:#308080;">)</span><span style="color:#406080;">;</span>
     &hellip;&hellip;
<span style="color:#406080;">}</span>
catch(Exception e)<span style="color:#406080;">{</span>
&hellip;<span style="color:#308080;">.</span><span style="color:#308080;">.</span> <span style="color:#595979;">//Обработка ошибки</span>
<span style="color:#406080;">}</span>
finally<span style="color:#406080;">{</span>
    <span style="color:#200080;font-weight:bold;">try</span><span style="color:#406080;">{</span>
         <span style="color:#200080;font-weight:bold;">if</span> <span style="color:#308080;">(</span>oos <span style="color:#308080;">!</span><span style="color:#308080;">=</span> <span style="color:#200080;font-weight:bold;">null</span><span style="color:#308080;">)</span>
             oos<span style="color:#308080;">.</span>close<span style="color:#308080;">(</span><span style="color:#308080;">)</span><span style="color:#406080;">;</span> <span style="color:#595979;">//тоже может выбросить исключение</span>
     <span style="color:#406080;">}</span> <span style="color:#200080;font-weight:bold;">catch</span><span style="color:#308080;">(</span><span style="color:#6679aa;font-weight:bold;">IOException</span> e<span style="color:#308080;">)</span><span style="color:#406080;">{</span>e<span style="color:#308080;">.</span>printStackTrace<span style="color:#308080;">(</span><span style="color:#308080;">)</span><span style="color:#406080;">;</span><span style="color:#406080;">}</span>
<span style="color:#406080;">}</span></pre></div><div>В Java7 с появлением конструкции Automatic Resource Management все сильно упростилось.</div><div><pre style="color:#000020;line-height:normal;">try (ObjectOutputStream oos = new ObjectOutputStream(baos))<span style="color:#406080;">{</span>
    &hellip;&hellip;
<span style="color:#406080;">}</span>
catch(IOException e)<span style="color:#406080;">{</span>
&hellip;<span style="color:#308080;">.</span><span style="color:#308080;">.</span> <span style="color:#595979;">//Обработка ошибки, в т. ч. и метода close()</span>
<span style="color:#406080;">}</span></pre></div><div><div>Единственное требование &ndash; реализация интерфейса <a class="wiki_link" href="/wiki/show/vsm2_1step/AutoCloseable" title="AutoCloseable">AutoCloseable</a> и метода close()</div></div><div><h2 id="d09dd0b0d0bfd0bed181d0bbd0b5d0b4d0bed0ba">Напоследок</h2><div><ul><li>Никогда не оставляйте catch пустым. Хотя бы делайте printStackTrace();&nbsp;</li><li>Порождая новое исключение передавайте ему старое</li><li>Используйте специфичные классы исключений</li><li>Не кидайте исключения через все слои приложения, старайтесь обрабатывать исключения на месте</li><li>Правильно выбирайте между проверяемыми и непроверяемыми исключениями</li></ul></div></div><div><br /></div><div><br /></div>