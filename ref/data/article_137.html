<html><head></head><body><span style="font-size:large;"><strong>Введение</strong></span>.<br>Для мобильной разработки у нас используется фреймворк NativeScript http://docs.nativescript.org, Angular 4 и язык TypeScript.<br>Перед началом рекомендуется ознакомится отдельно с TypeScript пройти тестовый курс тут http://docs.nativescript.org/angular/tutorial/ng-chapter-0 Там рассказывается про установку и настройку. В качестве эмулятора Android можно использовать стандартный, как освоишься со стандартным можно попробовать Genymotion - он быстрее работает.<br><br><strong>Репозиторий с мобильным приложением</strong><br>https://bitbucket.org/victor_follet/ip-mobile<br>Основные приложение ip-mobile\runidea, исходники ip-mobile\runidea\app<br>ip-mobile\README.txt - список скриптов, хотфикс бага в NativeScript на iOS,  - конфиг компилятора TypeScript<br>Скрипты tns запускаются из папки ip-mobile\runidea<br>Разберем её содержимое<br>    ip-mobile\runidea\app - исходники приложения. Структура близка к той, что в демо приложении, с него структура и бралась.<br>    ip-mobile\runidea\hooks - генерируется tns, скрипты сборки приложения<br>    ip-mobile\runidea\node_modules - библиотеки, как внутренние так и внешние<br>    ip-mobile\runidea\platforms - собранные файлы, если фикс этого https://github.com/NativeScript/NativeScript/pull/3587/commits/4b98cf72ac2ac3cf6c25fab5a474e0c4397269de бага, не починят в следующем релизе, то исправлять его нужно в этой папке    <br>    iOS fix<br>    https://github.com/NativeScript/NativeScript/pull/3587/commits/4b98cf72ac2ac3cf6c25fab5a474e0c4397269de<br>    < tabBar.items.count > 0 <br>    => <br>    < tabBar.items && tabBar.items.count > 0 <br><br><strong><span style="font-size:large;">ip-mobile\runidea\app</span></strong><br>    <em>Центральные файлы</em><br>        main.ts  - центральный файл, выполняет внедрение основного модуля (app.module.ts) Angular, включает продакшен режим Angular. Еще там были попытки исправить уже описанный баг с табами (функция applyTabViewHotfix), но из этого ничего не вышло, сейчас hot-fix отключен, а когда баг поправят его следует полностью удалить.<br>        app.module.ts - файл обеспечивает сборку всех модулей приложения (как стандартных, так и реализованных в приложении) в один модуль. Связывает центральный компонент (app.component.ts) и его роутинг (app.routing.ts)<br>        app.component.ts - центральный компонент содержит код page-router-outlet<br>        app.routing.ts - содержит сопоставление трех адресов приложения и трех основных компонентов перечисленных в ip-mobile\runidea\app\pages: LoginPage, ListPage и EntityPage<br>        Структура файлов main.ts, app.module.ts, app.component.ts и app.routing.ts - стандартная для большинства Angular2+ приложений. <br>        При изменении приложения новые страницы добавляются в app.routing.ts, а новые сервисы и компоненты  - в app.component.ts, компонеты страниц добавляются в app.component.ts из app.routing.ts автоматически через выражение ...navigatableComponents<br>    <strong>Компонеты для разных страниц</strong><br>        <strong>ip-mobile\runidea\app\action-bar</strong> - панель верхнего меню, реализует выход logout и переход к экрану логина<br>        <strong>ip-mobile\runidea\app\side-drawer</strong>- панель левого меню, открывается по кнопке гамбургера в верхнем меню, состоит из компонента самого меню ip-mobile\runidea\app\side-drawer\side-drawer-page и компонента кнопки (ip-mobile\runidea\app\side-drawer\borderless-btn.directive.ts), которая используется в качестве строки меню.<br>            ip-mobile\runidea\app\side-drawer\side-drawer-page компонент бокового меню работает на основе RadSideDrawerComponent из библиотеки nativescript-telerik-ui/sidedrawer<br>                side-drawer-page.component.ts<br>                По сравнению с библиотечным примером переопределяется navigateTo, который выполняет переход на другую страницу.<br>                    При этом мы <br>                        отписываемся от всех предыдущих событий на закрытие меню (это важно, что бы не было попыток двух переходов)<br>                        кидаем меню сигнал на закрытие<br>                        выяснем новую и URL, сравниваем со старой, и если они не равны, то после окончания закрытия меню выполняем переход <br>                side-drawer-page.component.html<br>                    RadSideDrawer принимает 2 аргумента: tkDrawerContent (шаблон левой панели) и tkMainContent (шаблон содержимого экрана). Первый - это просто список кнопок.<br>                    Второй - либо индикатор загрузки, если данные не прогрузились, либо - содержимое тега (оно подставляется на место ng-content)<br>            ip-mobile\runidea\app\side-drawer\borderless-btn.directive.ts - кнопка без рамок, реализована отдельно, поскольку требует доработки для API Android, копипаст из интернета<br>       <strong> ip-mobile\runidea\app\hot-fixes</strong> - сюда предполагается складывать исправления библиотек, но сейчас ни одно из них не используется<br>        <br>        <strong>ip-mobile\runidea\app\shared </strong>- разделяемые приложением данный. Типы данных и сервисы их получения и изменения<br><br>            <em>app\shared\values</em> - описание типов возможных значение полей (boolean, number, Pair, DateTime и т.д.)<br>                RecordValue.ts<br>                    - описывает перечеслимый тип JsType, описывающий возможные типы значений полей<br>                    - описывает абстрактный класс RecordValue от которого наследуются все остальные типы значений полей. У любого значения поля (даже примитвного типа string) есть следующий методы:<br>                        value - получить логическое значение<br>                        displayValue - получить значение для показа пользователю<br>                        toServer - получить значение для отправки серверу в теле POST или PUT запроса<br>                        toLookup - получить значение для отправки серверу в внутри URI параметров<br>                        set - получить новое значение, для установки на место старого<br>                <br>                ValueFactory.ts <br>                    fromServer - реализует конвертацию серверных значений в потомков RecordValue на основании JsType типа данных и того являются ли значения поля массивом (isArray) <br><br>                Реализованные типы значений полей RecordValue<br>                    NumberValue.ts, StringValue.ts, BooleanValue.ts - для примитивных значений number, string и boolean<br>                    EmptyValue.ts - для null и undefined<br>                    DateTimeValues.ts - реализует DateTimeValue, DateValue, TimeValue для дат в соответствующем формате<br>                    PairValue.ts - реализует значение для combobox<br>                    PairArrayValue.ts - реализует значение для массивов combobox<br><br>            <em>app\shared\definitions</em> - описание типов возможных полей-компонентов в системе ( number, text, textarea, attachment, richtext )<br><br>                ComponentDefinition.ts <br>                    - описывает перечеслимый тип FieldStyle, описывающий серверные типы полей<br>                    - описывает перечеслимый тип MobileWidget, описывающий реализованные в системе компонеты<br>                    - описывает абстрактный класс ComponentDefinition от которого наследуются все остальные компоненты, видно что у компоненты есть имя его поля, подпись поля, название серверного стиля, и название JS типа<br><br>                ComponentDefinitionFactory.ts- реализует конвертацию серверного описания поля в потомков ComponentDefinition, для компонента ComboBoxEntityDefinition использует lookupFunction для получение списка данных<br><br>                Реализованные типы полей ComponentDefinition:<br>                    StringDefinition - поле ввода строки<br>                    TextDefinition - поле ввода текста в несколько строк<br>                    BooleanDefinition - поле типа "галочка"<br>                    NumericDefinition - поле ввода чисел<br>                    DateDefinition - поле ввода даты<br>                    DateTimeDefinition - поле ввода даты с временем<br>                    TimeDefinition - поле ввода времени<br>                    ComboBoxListDefinition - поле combobox на основании списка<br>                    ComboBoxEntityDefinition - поле combobox на основании запроса к базе<br>            <br>            <em>app\shared\entity</em> - реализует работу с данными в форме одной записи и форме списка, их загрузку, создание и изменение<br>                entity.service.ts - работа с сервером<br>                    loadEntity - загрузка одной записи<br>                    initEntity - инициализация записи при создании<br>                    loadList - загрузка списка записей<br>                    loadLookup - загрузка списка для ComboBoxEntityDefinition<br>                    processButton - обработка нажатия на кнопку в форме одной записи<br>                ListRow.ts - описывает тип данных для отображения данных в форме списка<br>                entity.ts - описывает тип данных для отображения строки на форме одной записи, реализует изменение данных, содержит заготовки для реализации истории изменений для аналога UI-Engine<br>                    RecordValues - класс содержит текущие значения формы одной записи, реализует доступ к данным полей (а такде реализует перобразование к разным форматам), а также к таких характеристикам полей как isEditable, isRequired, isVisible. Представлет собой отдаленной аналог ProxyObject из UiRule web-версии <br>                    Record - класс содержит данные формы одной записи в виде класса RecordValues, реализует построение формы (ModileRecordForm) на основе данных от сервера, реализует нажатия на кнопку, а также содержит описание компонентов (_mobileForm) и их источников данных (_sources), по хорошему _sources логично перенести в компонеты, кторым они соответствуют<br>            <br>            <em>app\shared\sources</em> - реализует классы для доступа к серверу компоентов через механизм подписки на элемент класса Rx.Subject (подробнее http://reactivex.io/documentation/subject.html)<br>                CommentsSource.ts - единственный реализованный источник данных для комментариев к записи<br>                    ServerCommentData - формат комментариев от сервера<br>                    CommentDataHeader - данные заголовка группы комментариев<br>                    CommentData - данные отдельного комментария<br>                    CommentsSource - сам класс источника<br>                        _comments - объект типа Subject, на который можно подписаться и данные будут сами обновляться в компоненте сами, после того как в источнике будет сделан _comments.next<br>                        create - создает новый коммментарий и вызывает обновление объекта подписки<br>                        listToPlainTree - конвертация данных к клиентскому формату<br>                ListSource.ts - аналог CommentsSource для не реализованных виртуальных списков<br>                SourceFactory.ts - пока возвращает только CommentsSource<br><br>            <em>app\shared\types</em> - другие типы данных<br>                buttons.ts - содержит описание стандартных и кастомных кнопок, какие из них показывать на мобильниках, с какими иконками и где.<br>                forms.ts - описание класса формы и таба, помимо тривиального в нем показывается, что не нужно показывать таб с именем hidden, а общее число табов ограничивается Config.maxTabs<br><br>            <em>app\shared\user</em> - работа с данными пользователя<br>                user.service.ts - содержит методы логина и разлогина, записывает данные пользователя в глобальный объект Config<br>                user.ts - поля пользователя<br><br>           <em> app\shared\alerts</em> - реализует статический метод показа сообщений в диалоговом окне<br>            <br>            <em>app\shared\menu</em> - реализует сервис доступа к списку элементов меню. Делает преобразование пришедших от сервера данных к элементам меню для показа слева и прикрепления к кнопке создания.<br><br>           <em> app\shared\common.ts</em> - общие функции такие как toSystemCase, getProperty и setProperty без учета регистра<br><br>            <em>app\shared\config.ts</em> - объект с настройками приложения, содержит адрес к которому идет логин, форматы даты и времени, разделители и прочее. Также здесь сохраняется токен текущего пользователя.<br><br>        <strong>ip-mobile\runidea\app\directives</strong> - кастомные помпоненты, которые вставляются в различные страницы<br>            Общие моменты<br>                У компонентов ввода для передачи значения внутрь директивы используется @Input() value, а из директивы @Output() valueChange = new EventEmitter(), которые позволяют реализовать связывание значения с директивой как [value]="getValue(fieldName)" (valueChange)="setValue(fieldName, $event.value)"<br>                Пример https://toddmotto.com/component-events-event-emitter-output-angular-2#eventemitter<br>            <em>app\directives\combobox</em> - комбобох для ввода значений, работает в качестве выпадалки и автокомплита, использует библиотеку nativescript-drop-down, и использует примеры из неё (https://github.com/PeterStaev/NativeScript-Drop-Down), не использует пагинацию или загрузку по частично введенному слову<br>                combobox.ts - Список значений берется из определения поля. Пока список значений не инициализирован (listInitialized) работа с компонентом не ведется. Для хранения значений внутри компонента используется класс ValueList<br>            <em>app\directives\comments</em> - список комментариев с возможностью добавления<br>                comments.ts - <br>                    Реализует методы sendComment, а также обновление списка комментариев.<br>                    Для работы с данными использует специальный класс CommentsSource, который реализует метод создания комментария и метод чтения, причем метод чтения возвращает подписку, которая сама обновляет данные при их изменении внутри источника (внутри источника они правда меняются только вызовом create), а от самой подписки нужно не забыть отписаться.<br>                    Сохраняет ссылку на нативный элемент для прокрутки вниз при приходе новых данных.<br>           <em> app\directives\tablelist </em>- Не реализовано до конца. Потенциально должно реализовывать список записей для отображения на форме одной записей в качестве виртуального поля. Реализация должна быть схожа с comments<br>            <em>app\directives\create-dialog</em> - реализует модальное меню на создание новой записи, которое появляется при нажатие на плюсик в форме списка.<br>                create-dialog.ts - Реализует основной компонет, который использует сервис меню для получения списка возможных для создания записей и получает на вход closeCallback, который вызывается с нажатым элементом меню.<br>            <em>app\directives\timedatepicker</em> - редактор для дат, времени или и того и другого использует библиотеку nativescript-timedatepicker и её пример использования https://github.com/AntonioCuevaUrraco/nativescript-timedatepicker<br>                timedatepicker.ts - основной файл компонента реализует инициализацию и связывание данных<br>                timedatepicker-native.ts - файл реализующий открытие компонента, для Android реализует последовательное открытие редактора даты и времени, для iOS - параллельное.<br><br>        <strong>ip-mobile\runidea\app\pages</strong> - экраны приложения переход между которыми выполняется Angular-роутером<br>            <em>app\pages\login</em> - экран логина<br>                login.component.ts<br>                    login - блокирует кнопки при помощи isLoading, устанавливает текущее значение ввода в appSettings для последующих логинов, логинится при помощи _userService, инициализирует меню ответом от сервра и переходит к указнному в ответе сервера списку DefaultList<br>            <br>            <em>app\pages\list</em> - экран списка записей, представляет View списком записи, выводя у каждой по четыре значения (id, name, description, date). Соответствие между значения описывается в app\shared\entity\entity.service.ts loadList. Для показа кнопки добавляения в правом нижнем углу используется библиотека nativescript-floatingactionbutton (https://github.com/bradmartin/nativescript-floatingactionbutton)<br>                list.component.ts<br>                    constructor - инициализация и подписка на изменение роута (подробнее: https://docs.nativescript.org/core-concepts/angular-navigation#passing-parameter)<br>                    getMenuList - меню для показа слева, вызов пробрасывается к сервису меню<br>                    openItem - обработка тапа по элементу списка для открытия формы одной записи<br>                    logout - обработка разлогина, чистит токен авторизации и переходит к логину, стирая историю переходов, чтобы исключить возврат по аппаратной кнопке назад на Андроиде<br>                    openFab - открытие формы одной записи на создание, сначала тап вызывает открытие модального окна со списком возможных вариантов для создания, после разрешения полученного промиса делается переход на форму одной записи с rowId = 0<br>            <em>app\pages\entity</em> - поле одной записи для редактирования и создания отдельных записей<br>                entity.component.ts <br>                    Основной функционал работы с полями и кнопками реализуется через поле entity типа Record из app\shared\entity\entity.ts<br><br>                    constructor - инициализация и подписка на изменение роута (аналогично app\pages\list\list.component.ts)<br>                    refresh - обновление, создается подписка на обновление, которое в зависимости от того пришел положительный rowId или нет либо загружает имеющуюся запись, либо инициализирует новую. Также выставлает активным первый таб и инициализирует массив SegmentedBarItem для нормальный работы подписей табов.<br>                    setTab - выбор таба активным<br>                    form - ссылка на мобильные формы<br>                    buttons - ссылка на кнопки, распиханные по разным полям в зависимости от их назначения и предполагаемого положения на шаблоне<br>                    process - обработка нажатия на кнопку через this.entity.processButton<br>                    getField, getFieldWidget, getSource, setValue, getValue, getDisplayValue, get - проброс к соответствующим методам this.entity<br>                <br>                entity.html - Сверху в ActionBar ресуется подпись и кнопка сохранения, Под ним DockLayout для расположение трех основных элементов в заголовке (скролящийся горизонтально список табов), в футере (скролящийся горизонтально список кнопок) и по середине (скролящийся вертикально список полей).</body></html>