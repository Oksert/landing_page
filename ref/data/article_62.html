<html><head></head><body><p>Переменные, объекты и методы, которые можно использовать в определении серверных правил:</p><ol><li><span lang="EN-US">record</span> - экземпляр <span lang="EN-US">EntityDTO</span> несущий в себе текущую запись (та, что пришла с клиента);</li><li><span lang="EN-US">oldrecord</span> - экземпляр <span lang="EN-US">EntityDTO</span>, несущий в себе сохраненную запись (та, что сохранена на текущий момент в базе);</li><li><span lang="EN-US">ContextUtils</span>.<span lang="EN-US">getCurrentUserId</span>() - возвращает код текущего пользователя;</li><li><span lang="EN-US">ContextUtils</span>.<span lang="EN-US">getCurrentUser</span>() - возвращает экземпляр объекта <span lang="EN-US">User</span>, несущий в себе информацию о текущем пользователе (<span lang="EN-US">currentUser</span> еще можно, но рекомендуется использовать).</li><li>Класс User предназначен для хранения информации о текущем пользователе, его методы:<ul><li>getUserId() - возвращает код пользователя.</li><li>getLoginName() - возвращает login name пользователя.</li><li>getFullName() - возвращает ФИО пользователя.</li><li>getRoleId() - возвращает код роли пользователя.</li><li>isInAccessGroup(Integer accessGroupId) - возвращает true, если пользователь входит в группу доступа с кодом accessGroupId и false - в противном случае.</li></ul></li><li>Объект <span lang="EN-US">EntityDTO</span> и его методы и остальные методы объектов <span lang="EN-US">API</span><span lang="EN-US"> </span>системы описанные в разделе данного документа:</li></ol><p><span lang="EN-US">EntityDTO</span> – класс, позволяющий работать с объектами, загружаемыми из БД.</p><p><span lang="EN-US">Конструкторы:</span></p><ul><li>EntityDTO(String tableName) – создает пустой объект со структурой, соответствующей структуре таблицы tableName.</li><li>EntityDTO(String tableName, Integer rowId) – загружает в объект EntityDTO строку (структуру и данные) с номером rowId из таблицы tableName.</li></ul><p><span lang="EN-US">Методы:</span></p><ul><li>getEntityTypeId() - возвращает внутренний код таблицы, которой привязана текущая запись;</li><li>getTableName() - возвращает имя таблицы, которой привязана текущая запись;</li><li>getKeyValue() - возвращает код записи (значение rowId);</li><li><span lang="EN-US">get(String fieldName) – </span>возвращает значение поля <span lang="EN-US">fieldname;</span></li><li><span lang="EN-US">getDisplayValue(String fieldName) - </span>возвращает отображаемое значение для поля<span lang="EN-US"> fieldName (</span>учитывая<span lang="EN-US"> FieldFormat);</span></li><li><span lang="EN-US">getAsInteger(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Integer;</span></li><li><span lang="EN-US">getAsString(String fieldName)- </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> String;</span></li><li><span lang="EN-US">getAsBoolean(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Boolean;</span></li><li><span lang="EN-US">getAsDouble(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Double;</span></li><li><span lang="EN-US">getAsDateTime(String fieldName) -  </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> DateTime (Timestamp);</span></li><li><span lang="EN-US">getAsTimestamp(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Timestamp;</span></li><li><span lang="EN-US">getAsBooleanNullSub (String fieldName, Boolean defaultValue) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Boolean, </span>если<span lang="EN-US"> fieldName = null, </span>то возвращается значение<span lang="EN-US">, </span>указанное в поле<span lang="EN-US"> defaultValue;</span></li><li><span lang="EN-US">set(String fieldName, Object fieldValue) – </span>присваивает полю<span lang="EN-US"> fieldName </span>значение<span lang="EN-US"> fieldValue;</span></li><li><span lang="EN-US">setIfEmpty(String fieldName, Object fieldValue) - </span>присваивает полю<span lang="EN-US"> fieldName </span>значение<span lang="EN-US"> fieldValue </span>в случае<span lang="EN-US">, </span>если значение поля<span lang="EN-US"> fieldname </span>равно<span lang="EN-US"> null;</span></li><li>doInsert() - производит вставку текущего объекта в таблицу БД;</li><li>doUpdate() - производит обновление текущего объекта в БД;</li><li>doDelete() – производит удаление текущего объекта из БД;</li><li>processTransitions() - переводит текущий объект на следующий разрешенный шаг Workflow, если такой есть;</li><li>getTag() - возвращает тег текущего объекта. Тег - это строка, сформированная по шаблону: <tableName>:<rowId> (Пример: entityType:1 - это запись в таблице entityType с rowId = 1);</li><li>isWorkflowOn() - возвращает значение true - в случае, если в определении соответствующего EntityType выставлен флаг "Workflow включен" и false в противном случае;</li><li>getWorkflowId() - возвращает код Workflow, по которому следует текущая запись;</li><li>getWorkflowStepId() - возвращает код шага Workflow, на котором находится текущая запись;</li><li>setWorkflowId(Integer workflowId) - задает Workflow для текущей записи;</li><li>setWorkflowStepId(Integer workflowStepId) - задает шаг Workflow для текущий записи;</li><li>isEmpty() - возвращает true, если текущая запись пуста (не путать со значением null);</li><li>clone() - возвращает копию текущей записи с пустым значением уникального ключа и историей.</li></ul><p>Пример использования объекта <span lang="EN-US">EntityDTO</span>:</p><p>Вставка новой записи в таблицу <span lang="EN-US">DemoTable</span></p><p><span lang="EN-US">EntityDTO demoItem = new EntityDTO(“DemoTable”);</span></p><p><span lang="EN-US">demoItem.set(“displayName”, “This is demo code”);</span></p><p><span lang="EN-US">demoItem.doInsert();</span></p><ol><li>Класс <span lang="EN-US">QueryUtils</span> (все методы статические):<ul><li><span lang="EN-US">getCount</span>(<span lang="EN-US">String</span><span lang="EN-US"> </span><span lang="EN-US">tableName</span>, <span lang="EN-US">String</span><span lang="EN-US"> </span><span lang="EN-US">whereQuery</span>) – возвращает кол-во записей из таблицы  <span lang="EN-US">tableName</span>, удовлетворяющих запросу <span lang="EN-US">whereQuery</span>;</li><li>getCount(String sqlQuery) – возвращает результаты выполнения прямого count sql запроса;</li><li>getRecord(String tableName, String whereQuery) – возвращает 1 экземпляр EntityDTO из таблицы tableName, удовлетворяющий запросу whereQuery;</li><li>getRecordList(String tableName, String whereQuery) – возвращает список (List<EntityDTO>) записей из таблицы tableName, удовлетворяющих запросу  whereQuery;</li><li>getRecordList(String sqlQuery) – возвращает список (List<EntityDTO>) записей найденных при помощи sql-запроса sqlQuery.</li></ul></li><li>Класс <span lang="EN-US">CommonUtils:</span><ul><li><span lang="EN-US">isEmpty(T value) – </span>возвращает<span lang="EN-US"> true </span>случае<span lang="EN-US">, </span>если<span lang="EN-US"> value == null </span>или<span lang="EN-US"> value.isEmpty() == true, false – </span>в остальных случаях<span lang="EN-US">.</span></li><li>isSame(Tvalue1, Tvalue2) – возвращает true в случае, если значения value1 и value2 совпадают, false – в остальных случаях.</li><li><span lang="EN-US">nullSub(T value1,  T value2) – </span>возвращает<span lang="EN-US"> value1 </span>если<span lang="EN-US"> isEmpty(value1)==false. </span>В остальных случаях возвращает value2.</li><li>toUpperCase(String str) - безопасно (есть обработка null значения) приводит строку к верхнему регистру.</li><li>toLowerCase(String str) - безопасно (есть обработка null значения) приводит строку к нижнему регистру.</li><li>printStackTrace() - выводит стек вызовов функций (можно использовать для отладки).</li><li>getCurrentTimestamp() - возвращает текущую дату и время.</li></ul></li><li>Класс <span lang="EN-US">ContextUtils</span> содержит в себе методы по работе с окружением текущей сессии (в рамках которой происходит выполнение запроса от клиента), его методы:<ul><li>getCurrentUserId() - возвращает ID пользователя, от имени которого выполняется запрос.</li><li>getCurrentUserLogin() - возвращает Login пользователя, от имени которого выполняется запрос.</li><li>getCurrentUser() - возвращает объект User с описанием пользователя, от имени которого выполняется запрос.</li><li>addMessage(String messageText) - выводит на клиент сообщение с текстом messageText и уровнем INFO.</li><li>addMessage(String messageText, String level) - выводит на клиент сообщение с текстом messageText и уровнем level (возможные значения: INFO, WARN, ERROR).</li><li>getMessages() - возвращает список текущих сообщений.</li></ul></li></ol><p>10.<span style="font-size:7pt;font-family:'Times New Roman';">  </span>Класс <span lang="EN-US">NotificationUtils</span><span lang="EN-US"> </span>содержит набор методов для отправки оповещений пользователям системы:</p><p style="margin-left:0cm;text-indent:0cm;">Отправка оповещений по шаблону:</p><ul><li>sendNotification(Integer toUserId, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - отправляет оповещение одному пользователю по шаблону:</li><li><span lang="EN-US">toUserId</span> - код пользователя, которому необходимо отправить оповещение.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - запись до события</span>.</li><li><span lang="EN-US">sendNotification(Collection<Integer> toUserIds, Collection<Integer> ccUserIds, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - </span>отправляет оповещение нескольким пользователям по шаблону<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить оповещение.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию оповещения.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления, и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - запись до события.</span></li><li><span lang="EN-US">sendNotification(Collection<Integer> toUserIds, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - </span>отправляет оповещение нескольким пользователям по шаблону<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserids</span> - коды пользователей, которым необходимо отправить оповещение.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - </span>-<span lang="EN-US">запись до события</span>.</li></ul><p><span lang="EN-US">Отправка E</span>-<span lang="EN-US">mail</span>:</p><ul><li><span lang="EN-US">sendEmail(Collection<Integer> toUserIds, Collection<Integer> ccUserIds, String subject, String body, Collection<Integer> attachmentIds) - </span>отправляет<span lang="EN-US"> email </span>нескольким пользователям со вложениями<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить <span lang="EN-US">email</span>.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию <span lang="EN-US">email</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li><li><span lang="EN-US">attachmentIds</span> - номера вложений, которые необходимо приложить к письму.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body) - </span>отправляет оповещения пользователям без вложений<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить <span lang="EN-US">email</span>.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию <span lang="EN-US">email</span>.</li><li><span lang="EN-US">subject - тема письма.</span></li><li><span lang="EN-US">body - тело письма.</span></li><li><span lang="EN-US">sendEmail(Integer userId, String subject, String body) - </span>отправляет<span lang="EN-US"> email </span>одному пользователю</li><li><span lang="EN-US">userId - номер пользователя</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body, Collection<Integer> attachmentIds) - </span>отправляет<span lang="EN-US"> email </span>группе пользователей<span lang="EN-US">:</span></li><li><span lang="EN-US">toEmails</span> - адреса электронной почты, которым нужно доставить сообщение (разделенные точкой с запятой).</li><li><span lang="EN-US">ccEmails</span> - адреса электронной почты, которые нужно поместить в копию <span lang="EN-US">(разделенные точкой с запятой).</span></li><li><span lang="EN-US">subject - тема письма.</span></li><li><span lang="EN-US">body - тело письма.</span></li><li><span lang="EN-US">attachmentIds</span> - номера вложений, которые необходимо приложить к письму.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body) - </span>отправляет<span lang="EN-US"> email </span>группе пользователей<span lang="EN-US">:</span></li><li><span lang="EN-US">toEmails</span> - адреса электронной почты, которым нужно доставить сообщение (разделенные точкой с запятой).</li><li><span lang="EN-US">ccEmails</span> - адреса электронной почты, которые нужно поместить в копию <span lang="EN-US">(разделенные точкой с запятой)</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li></ul><p>11.<span style="font-size:7pt;font-family:'Times New Roman';">  </span>Класс <span lang="EN-US">CalendarUtils</span><span lang="EN-US"> </span>содержит набор методов для использования объекта системы «<span>Календарь</span>»:</p><ul><li><span lang="EN-US">DateTime addPeriod(String calendarName, DateTime dateTime, Period period) - </span>прибавляет в дате<span lang="EN-US">/</span>времени<span lang="EN-US"> dateTime </span>период времени<span lang="EN-US"> period </span>по календарю<span lang="EN-US"> calendarName.</span></li><li><span lang="EN-US">Timestamp addPeriod(String calendarName, Timestamp dateTime, Time time) - </span>прибавляет в дате<span lang="EN-US">/</span>времени<span lang="EN-US"> dateTime </span>период времени<span lang="EN-US"> period </span>по календарю<span lang="EN-US"> calendarName.</span></li></ul><p><span style="background:red;">Пара слов про </span><span lang="EN-US" style="background:red;">DateTime</span><span style="background:red;">, </span><span lang="EN-US" style="background:red;">Period</span><span style="background:red;"> и т.д:</span></p><p><span lang="EN-US" style="background:red;">http</span><span style="background:red;">://</span><span lang="EN-US" style="background:red;">www</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">joda</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">org</span><span style="background:red;">/</span><span lang="EN-US" style="background:red;">joda</span><span style="background:red;">-</span><span lang="EN-US" style="background:red;">time</span><span style="background:red;">/</span><span lang="EN-US" style="background:red;">userguide</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">html</span></p><p><span style="background:red;"> </span></p><p><span lang="EN-US" style="background:red;">http</span><span style="background:red;">://</span><span lang="EN-US" style="background:red;">joda</span><span style="background:red;">-</span><span lang="EN-US" style="background:red;">time</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">sourceforge</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">net</span><span style="background:red;">/</span><span lang="EN-US" style="background:red;">key</span><span style="background:red;">_</span><span lang="EN-US" style="background:red;">instant</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">html</span></p><p><span lang="EN-US" style="background:red;">http</span><span style="background:red;">://</span><span lang="EN-US" style="background:red;">joda</span><span style="background:red;">-</span><span lang="EN-US" style="background:red;">time</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">sourceforge</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">net</span><span style="background:red;">/</span><span lang="EN-US" style="background:red;">key</span><span style="background:red;">_</span><span lang="EN-US" style="background:red;">period</span><span style="background:red;">.</span><span lang="EN-US" style="background:red;">html</span></p><p style="margin-left:18.0pt;text-indent:0cm;">Вычисления выполняются по календарю, но без учета праздников (таблицы <span lang="EN-US">CalendarEvent</span>).</p><ul><li><span lang="EN-US">addWorkDays(String calendarName, DateTime dateTime, Integer daysCount); - </span>добавляет рабочие дни согласно календарю</li><li><span lang="EN-US">getWorkDays(String calendarName, DateTime stDateTime, DateTime fnDateTime) - </span>вычисляет кол<span lang="EN-US">-</span>во рабочих дней между двумя датами согласно календарю<span lang="EN-US">.</span></li></ul><p style="margin-left:0cm;text-indent:0cm;">Пример использования<span lang="EN-US">:</span></p><p><span lang="EN-US">DateTime stDt = new DateTime();</span></p><p><span lang="EN-US">DateTime fnDt = CalendarUtils.addWorkDays("24x7", stDt, 7);</span></p><p><span lang="EN-US">log.info(stDt + " + 7 days =" + fnDt);</span></p><p><span lang="EN-US">Integer wdCnt = CalendarUtils.getWorkDays("9x5", stDt, fnDt);</span></p><p><span lang="EN-US">log.info(fnDt + " - " + stDt + " = " + wdCnt + " days.");</span></p></body></html>