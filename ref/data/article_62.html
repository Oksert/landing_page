<html><head></head><body><h3>Переменные, объекты и классы</h3><p>В правилах и других настройках системы, где можно писать код на Java для обращения к объектам системы можно использовать переменные, объекты и методы серверного API:</p><ol><li><span lang="EN-US">record</span> - экземпляр класса <span lang="EN-US">EntityDTO</span> несущий в себе текущую запись (та, что пришла с клиента);</li><li><span lang="EN-US">oldrecord</span> - экземпляр класса <span lang="EN-US">EntityDTO</span>, несущий в себе сохраненную запись (та, что сохранена на текущий момент в базе);</li><li><span lang="EN-US">ContextUtils</span>.<span lang="EN-US">getCurrentUserId</span>() - возвращает код текущего пользователя;</li><li><span lang="EN-US">ContextUtils</span>.<span lang="EN-US">getCurrentUser</span>() - возвращает экземпляр объекта <span lang="EN-US">User</span>, несущий в себе информацию о текущем пользователе </li><li>Объект <span lang="EN-US">EntityDTO</span> и его методы и остальные методы объектов <span lang="EN-US">API</span><span lang="EN-US"> </span>системы описанные в разделе данного документа:</li></ol><h4><span lang="EN-US"></span>Класс EntityDTO</h4><p><span lang="EN-US">EntityDTO</span> – класс, позволяющий работать с объектами, загружаемыми из БД. </p><p>Конструкторы:</p><ul><li>EntityDTO(String tableName) – создает пустой объект со структурой, соответствующей структуре таблицы tableName.</li><li>EntityDTO(String tableName, Integer rowId) – загружает в объект EntityDTO строку (структуру и данные) с номером rowId из таблицы tableName.</li></ul><p>Экземпляр класса хранит в себе все атрибуты, которые определены в соответствующей таблице и м<span lang="EN-US">етоды для работы с данными:</span></p><ul><li>getEntityTypeId() - возвращает внутренний код таблицы, которой привязана текущая запись;</li><li>getTableName() - возвращает имя таблицы, которой привязана текущая запись;</li><li>getKeyValue() - возвращает код записи (значение rowId);</li><li><span lang="EN-US">get(String fieldName) – </span>возвращает значение поля <span lang="EN-US">fieldname;</span></li><li><span lang="EN-US">getDisplayValue(String fieldName) - </span>возвращает отображаемое значение для поля<span lang="EN-US"> fieldName (</span>учитывая<span lang="EN-US"> FieldFormat);</span></li><li><span lang="EN-US">getAsInteger(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Integer;</span></li><li><span lang="EN-US">getAsString(String fieldName)- </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> String;</span></li><li><span lang="EN-US">getAsBoolean(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Boolean;</span></li><li><span lang="EN-US">getAsDouble(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Double;</span></li><li><span lang="EN-US">getAsDateTime(String fieldName) -  </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> DateTime (Timestamp);</span></li><li><span lang="EN-US">getAsTimestamp(String fieldName) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Timestamp;</span></li><li><span lang="EN-US">getAsBooleanNullSub (String fieldName, Boolean defaultValue) - </span>возвращает значение поля<span lang="EN-US"> fieldName </span>и приводит его к типу<span lang="EN-US"> Boolean, </span>если<span lang="EN-US"> fieldName = null, </span>то возвращается значение<span lang="EN-US">, </span>указанное в поле<span lang="EN-US"> defaultValue;</span></li><li><span lang="EN-US">set(String fieldName, Object fieldValue) – </span>присваивает полю<span lang="EN-US"> fieldName </span>значение<span lang="EN-US"> fieldValue;</span></li><li><span lang="EN-US">setIfEmpty(String fieldName, Object fieldValue) - </span>присваивает полю<span lang="EN-US"> fieldName </span>значение<span lang="EN-US"> fieldValue </span>в случае<span lang="EN-US">, </span>если значение поля<span lang="EN-US"> fieldname </span>равно<span lang="EN-US"> null;</span></li><li>doInsert() - производит вставку текущего объекта в таблицу БД;</li><li>doUpdate() - производит обновление текущего объекта в БД;</li><li>doDelete() – производит удаление текущего объекта из БД;</li><li>processTransitions() - переводит текущий объект на следующий разрешенный шаг Workflow, если такой есть;</li><li>getTag() - возвращает тег текущего объекта. Тег - это строка, сформированная по шаблону: <tableName>:<rowId> (Пример: entityType:1 - это запись в таблице entityType с rowId = 1);</li><li>isWorkflowOn() - возвращает значение true - в случае, если в определении соответствующего EntityType выставлен флаг "Workflow включен" и false в противном случае;</li><li>getWorkflowId() - возвращает код Workflow, по которому следует текущая запись;</li><li>getWorkflowStepId() - возвращает код шага Workflow, на котором находится текущая запись;</li><li>setWorkflowId(Integer workflowId) - задает Workflow для текущей записи;</li><li>setWorkflowStepId(Integer workflowStepId) - задает шаг Workflow для текущий записи;</li><li>isEmpty() - возвращает true, если текущая запись пуста (не путать со значением null);</li><li>clone() - возвращает копию текущей записи с пустым значением уникального ключа и историей.</li></ul><p>Пример использования объекта <span lang="EN-US">EntityDTO</span>:</p><p>Вставка новой записи в таблицу <span lang="EN-US">DemoTable</span></p><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin:0;line-height:125%;">EntityDTO demoItem <span style="color:#333333;">=</span> <span style="color:#008800;font-weight:bold;">new</span> EntityDTO<span style="color:#333333;">(</span><span style="color:#FF0000;background-color:#FFAAAA;">“</span>DemoTable<span style="color:#FF0000;background-color:#FFAAAA;">”</span><span style="color:#333333;">);</span>

demoItem<span style="color:#333333;">.</span><span style="color:#0000CC;">set</span><span style="color:#333333;">(</span><span style="color:#FF0000;background-color:#FFAAAA;">“</span>displayName<span style="color:#FF0000;background-color:#FFAAAA;">”</span><span style="color:#333333;">,</span> <span style="color:#FF0000;background-color:#FFAAAA;">“</span>This is demo code<span style="color:#FF0000;background-color:#FFAAAA;">”</span><span style="color:#333333;">);</span>

demoItem<span style="color:#333333;">.</span><span style="color:#0000CC;">doInsert</span><span style="color:#333333;">();</span>
</pre></div><h4>Класс <span lang="EN-US">QueryUtils</span></h4><p>Класс QueryUtils предназначен для выполнения запросов к объектам системы. Все запросы можно писать на языке SQL при этом используя названия атрибутов и объектов как в системе.</p><p>Методы класса <span lang="EN-US">QueryUtils</span> (все методы статические):</p><ul><li><span lang="EN-US">getCount</span>(<span lang="EN-US">String</span> <span lang="EN-US">tableName</span>, <span lang="EN-US">String</span> <span lang="EN-US">whereQuery</span>) – возвращает кол-во записей из таблицы  <span lang="EN-US">tableName</span>, удовлетворяющих запросу <span lang="EN-US">whereQuery</span>;</li><li>getCount(String sqlQuery) – возвращает результаты выполнения прямого count sql запроса;</li><li>getRecord(String tableName, String whereQuery) – возвращает 1 экземпляр EntityDTO из таблицы tableName, удовлетворяющий запросу whereQuery;</li><li>getRecordList(String tableName, String whereQuery) – возвращает список (List<EntityDTO>) записей из таблицы tableName, удовлетворяющих запросу  whereQuery;</li><li>getRecordList(String sqlQuery) – возвращает список (List<EntityDTO>) записей найденных при помощи sql-запроса sqlQuery.</li></ul><p>Пример использования класса QueryUtils: Найдем запись со значение  «This is demo code» в поле displayName объекта DemoTable </p><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin:0;line-height:125%;">EntityDTO demoItem <span style="color:#333333;">=</span> QueryUtils<span style="color:#333333;">.</span><span style="color:#0000CC;">getRecord</span><span style="color:#333333;">(</span><span style="color:#FF0000;background-color:#FFAAAA;">“</span>DemoTable<span style="color:#FF0000;background-color:#FFAAAA;">”</span><span style="color:#333333;">,</span> <span style="color:#FF0000;background-color:#FFAAAA;">“</span>displayName<span style="color:#333333;">=</span><span style="color:#FF0000;background-color:#FFAAAA;">’</span>This is demo code<span style="color:#FF0000;background-color:#FFAAAA;">’”</span><span style="color:#333333;">);</span>
</pre></div><h4>Класс User</h4><ul></ul><p>Класс User предназначен для хранения информации о текущем пользователе, его методы:</p><ul style="margin-bottom:0px;"><li>getUserId() - возвращает код пользователя.</li><li>getLoginName() - возвращает login name пользователя.</li><li>getFullName() - возвращает ФИО пользователя.</li><li>getRoleId() - возвращает код роли пользователя.</li><li>isInAccessGroup(Integer accessGroupId) - возвращает true, если пользователь входит в группу доступа с кодом accessGroupId и false - в противном случае.</li></ul><h4>Класс <span lang="EN-US">ContextUtils</span></h4><p>Класс <span lang="EN-US">ContextUtils</span> содержит в себе методы по работе с окружением текущей сессии (в рамках которой происходит выполнение запроса от клиента), его методы:</p><ul><li>getCurrentUserId() - возвращает ID пользователя, от имени которого выполняется запрос.</li><li>getCurrentUserLogin() - возвращает Login пользователя, от имени которого выполняется запрос.</li><li>getCurrentUser() - возвращает объект User с описанием пользователя, от имени которого выполняется запрос.</li><li>addMessage(String messageText) - выводит на клиент сообщение с текстом messageText и уровнем INFO.</li><li>addMessage(String messageText, String level) - выводит на клиент сообщение с текстом messageText и уровнем level (возможные значения: INFO, WARN, ERROR).</li><li>getMessages() - возвращает список текущих сообщений.</li></ul><h4 style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;color:#333333;">Класс <span lang="EN-US">CommonUtils</span></h4><ul><li><span lang="EN-US">isEmpty(T value) – </span>возвращает<span lang="EN-US"> true </span>случае<span lang="EN-US">, </span>если<span lang="EN-US"> value == null </span>или<span lang="EN-US"> value.isEmpty() == true, false – </span>в остальных случаях<span lang="EN-US">.</span></li><li>isSame(Tvalue1, Tvalue2) – возвращает true в случае, если значения value1 и value2 совпадают, false – в остальных случаях.</li><li><span lang="EN-US">nullSub(T value1,  T value2) – </span>возвращает<span lang="EN-US"> value1 </span>если<span lang="EN-US"> isEmpty(value1)==false. </span>В остальных случаях возвращает value2.</li><li>toUpperCase(String str) - безопасно (есть обработка null значения) приводит строку к верхнему регистру.</li><li>toLowerCase(String str) - безопасно (есть обработка null значения) приводит строку к нижнему регистру.</li><li>printStackTrace() - выводит стек вызовов функций (можно использовать для отладки).</li><li>getCurrentTimestamp() - возвращает текущую дату и время.</li></ul><h4>Класс <span lang="EN-US">NotificationUtils</span></h4><p>Класс <span lang="EN-US">NotificationUtils</span> содержит набор методов для отправки оповещений пользователям системы:</p><p style="margin-left:0cm;text-indent:0cm;">Отправка оповещений по шаблону:</p><ul><li>sendNotification(Integer toUserId, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - отправляет оповещение одному пользователю по шаблону:</li><li><span lang="EN-US">toUserId</span> - код пользователя, которому необходимо отправить оповещение.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - запись до события</span>.</li><li><span lang="EN-US">sendNotification(Collection<Integer> toUserIds, Collection<Integer> ccUserIds, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - </span>отправляет оповещение нескольким пользователям по шаблону<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить оповещение.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию оповещения.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления, и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - запись до события.</span></li><li><span lang="EN-US">sendNotification(Collection<Integer> toUserIds, Integer notificationId, EntityDTO record, EntityDTO oldrecord) - </span>отправляет оповещение нескольким пользователям по шаблону<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserids</span> - коды пользователей, которым необходимо отправить оповещение.</li><li><span lang="EN-US">notificationId</span> - номер шаблона, по которому необходимо построить оповещение (способ уведомления и шаблон текста учитывается в методе отправки).</li><li><span lang="EN-US">record</span> - запись после события (после добавления, после обновления, после перехода).</li><li><span lang="EN-US">oldrecord - </span>-<span lang="EN-US">запись до события</span>.</li></ul><p><span lang="EN-US">Отправка E</span>-<span lang="EN-US">mail</span>:</p><ul><li><span lang="EN-US">sendEmail(Collection<Integer> toUserIds, Collection<Integer> ccUserIds, String subject, String body, Collection<Integer> attachmentIds) - </span>отправляет<span lang="EN-US"> email </span>нескольким пользователям со вложениями<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить <span lang="EN-US">email</span>.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию <span lang="EN-US">email</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li><li><span lang="EN-US">attachmentIds</span> - номера вложений, которые необходимо приложить к письму.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body) - </span>отправляет оповещения пользователям без вложений<span lang="EN-US">:</span></li><li><span lang="EN-US">toUserIds</span> - коды пользователей, которым необходимо отправить <span lang="EN-US">email</span>.</li><li><span lang="EN-US">ccUserIds</span> - коды пользователей, которым необходимо отправить копию <span lang="EN-US">email</span>.</li><li><span lang="EN-US">subject - тема письма.</span></li><li><span lang="EN-US">body - тело письма.</span></li><li><span lang="EN-US">sendEmail(Integer userId, String subject, String body) - </span>отправляет<span lang="EN-US"> email </span>одному пользователю</li><li><span lang="EN-US">userId - номер пользователя</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body, Collection<Integer> attachmentIds) - </span>отправляет<span lang="EN-US"> email </span>группе пользователей<span lang="EN-US">:</span></li><li><span lang="EN-US">toEmails</span> - адреса электронной почты, которым нужно доставить сообщение (разделенные точкой с запятой).</li><li><span lang="EN-US">ccEmails</span> - адреса электронной почты, которые нужно поместить в копию <span lang="EN-US">(разделенные точкой с запятой).</span></li><li><span lang="EN-US">subject - тема письма.</span></li><li><span lang="EN-US">body - тело письма.</span></li><li><span lang="EN-US">attachmentIds</span> - номера вложений, которые необходимо приложить к письму.</li><li><span lang="EN-US">sendEmail(String toEmails, String ccEmails, String subject, String body) - </span>отправляет<span lang="EN-US"> email </span>группе пользователей<span lang="EN-US">:</span></li><li><span lang="EN-US">toEmails</span> - адреса электронной почты, которым нужно доставить сообщение (разделенные точкой с запятой).</li><li><span lang="EN-US">ccEmails</span> - адреса электронной почты, которые нужно поместить в копию <span lang="EN-US">(разделенные точкой с запятой)</span>.</li><li><span lang="EN-US">subject - тема письма</span>.</li><li><span lang="EN-US">body - тело письма</span>.</li></ul><h4>Класс <span lang="EN-US">CalendarUtils</span><span lang="EN-US"> </span></h4><p>Класс <span lang="EN-US">CalendarUtils</span><span lang="EN-US"> </span>содержит набор методов для использования объекта системы «Календарь»:</p><ul><li><span lang="EN-US">DateTime addPeriod(String calendarName, DateTime dateTime, Period period) - </span>прибавляет в дате<span lang="EN-US">/</span>времени<span lang="EN-US"> dateTime </span>период времени<span lang="EN-US"> period </span>по календарю<span lang="EN-US"> calendarName.</span></li><li><span lang="EN-US">Timestamp addPeriod(String calendarName, Timestamp dateTime, Time time) - </span>прибавляет в дате<span lang="EN-US">/</span>времени<span lang="EN-US"> dateTime </span>период времени<span lang="EN-US"> period </span>по календарю<span lang="EN-US"> calendarName.</span></li></ul><p><span style="background:rgb(255, 255, 255);">Пара слов про DateTime, Period и т.д:</span></p><p><span lang="EN-US" style="background:rgb(255, 255, 255);"><a href="http://www.joda.org/joda-time/userguide.html">http://www.joda.org/joda-time/userguide.html</a></span></p><p><span lang="EN-US" style="background:rgb(255, 255, 255);"><a href="http://joda-time.sourceforge.net/key_instant.html">http://joda-time.sourceforge.net/key_instant.html</a></span></p><p><span lang="EN-US" style="background:rgb(255, 255, 255);"><a href="http://joda-time.sourceforge.net/key_instant.html">http://joda-time.sourceforge.net/key_period.html</a></span></p><p>Вычисления выполняются по календарю с учетом праздников и исключений (таблицы <span lang="EN-US">CalendarEvent</span>).</p><ul><li><span lang="EN-US">addWorkDays(String calendarName, DateTime dateTime, Integer daysCount); - </span>добавляет рабочие дни согласно календарю</li><li><span lang="EN-US">getWorkDays(String calendarName, DateTime stDateTime, DateTime fnDateTime) - </span>вычисляет кол<span lang="EN-US">-</span>во рабочих дней между двумя датами согласно календарю<span lang="EN-US">.</span></li></ul><p style="margin-left:0cm;text-indent:0cm;">Пример использования:<!-- HTML generated using hilite.me --></p><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin:0;line-height:125%;">DateTime stDt <span style="color:#333333;">=</span> <span style="color:#008800;font-weight:bold;">new</span> DateTime<span style="color:#333333;">();</span>
DateTime fnDt <span style="color:#333333;">=</span> CalendarUtils<span style="color:#333333;">.</span><span style="color:#0000CC;">addWorkDays</span><span style="color:#333333;">(</span><span style="background-color:#fff0f0;">"24x7"</span><span style="color:#333333;">,</span> stDt<span style="color:#333333;">,</span> <span style="color:#0000DD;font-weight:bold;">7</span><span style="color:#333333;">);</span>
log<span style="color:#333333;">.</span><span style="color:#0000CC;">info</span><span style="color:#333333;">(</span>stDt <span style="color:#333333;">+</span> <span style="background-color:#fff0f0;">" + 7 days ="</span> <span style="color:#333333;">+</span> fnDt<span style="color:#333333;">);</span>
Integer wdCnt <span style="color:#333333;">=</span> CalendarUtils<span style="color:#333333;">.</span><span style="color:#0000CC;">getWorkDays</span><span style="color:#333333;">(</span><span style="background-color:#fff0f0;">"9x5"</span><span style="color:#333333;">,</span> stDt<span style="color:#333333;">,</span> fnDt<span style="color:#333333;">);</span>
log<span style="color:#333333;">.</span><span style="color:#0000CC;">info</span><span style="color:#333333;">(</span>fnDt <span style="color:#333333;">+</span> <span style="background-color:#fff0f0;">" - "</span> <span style="color:#333333;">+</span> stDt <span style="color:#333333;">+</span> <span style="background-color:#fff0f0;">" = "</span> <span style="color:#333333;">+</span> wdCnt <span style="color:#333333;">+</span> <span style="background-color:#fff0f0;">" days."</span><span style="color:#333333;">);</span>
</pre></div><h4 style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;color:#333333;">Класс Url<span lang="EN-US">Utils</span><span lang="EN-US"> </span></h4><p>Возвращает ссылки на объекты системы c помощью следующих методов:</p><ul><li>UrlUtils.getUrlToRecord(EntityDTO entity) - создает ссылку на форму просмотра 1 записи по сущности</li><li>UrlUtils.getUrlToRecord(Integer entityTypeId, Integer entityId) - делает то же самое, только по номеру сущности и номеру объекта</li><li>UrlUtils.String getBaseUrl() - возвращает ссылку на систему в целом</li></ul><p></p><br></body></html>