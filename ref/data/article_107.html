<html><head></head><body><p>Для создания dblink для связки mssql-postgres необходимо:</p><p></p><p>1. Скачать <a href="http://www.postgresonline.com/journal/archives/340-Foreign-Data-Wrappers-for-PostgreSQL-9.4-Windows.html">здесь</a> исходники Foreign Data Wrapper (ссылка актуальна для OS Windows/Postgres 9.4, если отличается версия ОС или Postgres, то необходим другой пакет, который легко найти по соответствующему запросу в Google) и следуя руководству из вложенного в скачиваемый архив файла README.txt скопировать необходимые файлы в папку с инсталляцией Postgres.</p><p></p><p>2. Создать источник данных для подключения БД MSSQL (подробнее о создании System DSN на примере Windows Server 2008 см. <a href="http://www.orionscache.com/2012/12/creating-a-32-bit-odbc-dsn-in-windows-2008r2/">здесь</a>).</p><p></p><p>3. Выполнить следующие SQL-команды в Postgres:</p><p>// создать расширение для работы установленного на первом шаге Foreign Data Wrapper</p><!-- HTML generated using hilite.me --><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tbody><tr><td><pre style="margin:0;line-height:125%;">1</pre></td><td><pre style="margin:0;line-height:125%;"><span style="color:#008800;font-weight:bold;">CREATE</span> EXTENSION ogr_fdw;
</pre></td></tr></tbody></table></div><p>//создать сервер и настроить его связь с источником данных в таблице StationPlanTST из БД MSSQL</p><!-- HTML generated using hilite.me --><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tbody><tr><td><pre style="margin:0;line-height:125%;">1
2
3</pre></td><td><pre style="margin:0;line-height:125%;"><span style="color:#008800;font-weight:bold;">CREATE</span> SERVER tablocutr <span style="color:#008800;font-weight:bold;">foreign</span> <span style="color:#008800;font-weight:bold;">data</span> wrapper ogr_fdw <span style="color:#008800;font-weight:bold;">options</span> (datasource <span style="background-color:#fff0f0;">'ODBC:cutr/cutr@tablo_cutr'</span>, format <span style="background-color:#fff0f0;">'ODBC'</span>);

<span style="color:#008800;font-weight:bold;">ALTER</span> SERVER tablocutr <span style="color:#008800;font-weight:bold;">options</span> (<span style="color:#008800;font-weight:bold;">set</span> datasource <span style="background-color:#fff0f0;">'ODBC:cutr/cutr@tablo_cutr,information_schema.columns,dbo.StationPlanTST'</span>);
</pre></td></tr></tbody></table></div><p>//создать системную таблицу, которая будет хранить структуру импортируемых таблиц</p><!-- HTML generated using hilite.me --><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tbody><tr><td><pre style="margin:0;line-height:125%;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td><pre style="margin:0;line-height:125%;"><span style="color:#008800;font-weight:bold;">CREATE</span> <span style="color:#008800;font-weight:bold;">FOREIGN</span> <span style="color:#008800;font-weight:bold;">TABLE</span> tds_information_schema_columns (
  fid <span style="color:#007020;">integer</span>,
  geom bytea,
  table_catalog <span style="color:#007020;">varchar</span>,
  table_schema <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">table_name</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">column_name</span> <span style="color:#007020;">varchar</span>,
  ordinal_position <span style="color:#007020;">integer</span>,
  column_default <span style="color:#007020;">varchar</span>,
  is_nullable <span style="color:#007020;">varchar</span>,
  data_type <span style="color:#007020;">varchar</span>,
  character_maximum_length <span style="color:#007020;">integer</span>,
  character_octet_length <span style="color:#007020;">integer</span>,
  numeric_precision <span style="color:#007020;">varchar</span>,
  numeric_precision_radix <span style="color:#007020;">integer</span>,
  numeric_scale <span style="color:#007020;">integer</span>,
  datetime_precision <span style="color:#007020;">integer</span>,
  <span style="color:#008800;font-weight:bold;">character_set_catalog</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">character_set_schema</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">character_set_name</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">collation_catalog</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">collation_schema</span> <span style="color:#007020;">varchar</span>,
  <span style="color:#008800;font-weight:bold;">collation_name</span> <span style="color:#007020;">varchar</span>,
  domain_catalog <span style="color:#007020;">varchar</span>,
  domain_schema <span style="color:#007020;">varchar</span>,
  domain_name <span style="color:#007020;">varchar</span> )
  SERVER tablocutr
  <span style="color:#008800;font-weight:bold;">OPTIONS</span> ( layer <span style="background-color:#fff0f0;">'INFORMATION_SCHEMA.COLUMNS'</span> );
</pre></td></tr></tbody></table></div><p>//сгенерировать запрос для создания импортируемой в Postgres таблицы</p><!-- HTML generated using hilite.me --><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tbody><tr><td><pre style="margin:0;line-height:125%;">1
2
3
4
5
6
7</pre></td><td><pre style="margin:0;line-height:125%;"><span style="color:#008800;font-weight:bold;">SELECT</span> <span style="background-color:#fff0f0;">'CREATE FOREIGN TABLE '</span> <span style="color:#333333;">||</span> <span style="color:#008800;font-weight:bold;">table_name</span> <span style="color:#333333;">||</span> <span style="background-color:#fff0f0;">' (fid int, geom bytea, '</span> <span style="color:#333333;">||</span> 
    string_agg(<span style="color:#008800;font-weight:bold;">column_name</span> <span style="color:#333333;">||</span> <span style="background-color:#fff0f0;">' '</span> <span style="color:#333333;">||</span> data_type, <span style="background-color:#fff0f0;">','</span> <span style="color:#008800;font-weight:bold;">ORDER</span> <span style="color:#008800;font-weight:bold;">BY</span> ordinal_position ) <span style="color:#333333;">||</span> <span style="background-color:#fff0f0;">') </span>
<span style="background-color:#fff0f0;">SERVER mssql_tds_test </span>
<span style="background-color:#fff0f0;">OPTIONS ( layer '''</span> <span style="color:#333333;">||</span> table_schema <span style="color:#333333;">||</span> <span style="background-color:#fff0f0;">'.'</span> <span style="color:#333333;">||</span> <span style="color:#008800;font-weight:bold;">table_name</span> <span style="color:#333333;">||</span> <span style="background-color:#fff0f0;">''' ) '</span>
<span style="color:#008800;font-weight:bold;">FROM</span> tds_information_schema_columns 
<span style="color:#008800;font-weight:bold;">WHERE</span> <span style="color:#008800;font-weight:bold;">UPPER</span>(<span style="color:#008800;font-weight:bold;">table_name</span>) <span style="color:#008800;font-weight:bold;">IN</span>(<span style="background-color:#fff0f0;">'STATIONPLANTST'</span>) <span style="color:#008800;font-weight:bold;">AND</span> table_schema <span style="color:#333333;">=</span> <span style="background-color:#fff0f0;">'dbo'</span>
<span style="color:#008800;font-weight:bold;">GROUP</span> <span style="color:#008800;font-weight:bold;">BY</span> table_schema, <span style="color:#008800;font-weight:bold;">table_name</span>;
</pre></td></tr></tbody></table></div><p></p><p>//полученный запрос будет следующего вида (при необходимости создайте представление на основе созданной Foreign Table и внесите правки в типы данных по каждой колонке - особое внимание уделите типам данных, связанных с датами и временем):</p><!-- HTML generated using hilite.me --><div style="background:#ffffff;overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tbody><tr><td><pre style="margin:0;line-height:125%;">1
2
3
4
5
6
7</pre></td><td><pre style="margin:0;line-height:125%;"><span style="color:#008800;font-weight:bold;">CREATE</span> <span style="color:#008800;font-weight:bold;">FOREIGN</span> <span style="color:#008800;font-weight:bold;">TABLE</span> tmvhi7n2.StationPlanTST (fid <span style="color:#007020;">int</span>, geom bytea, num <span style="color:#007020;">varchar</span>,<span style="color:#007020;">date</span> <span style="color:#007020;">varchar</span>,time_departure <span style="color:#007020;">varchar</span>,time_departure_fact <span style="color:#007020;">varchar</span>,station <span style="color:#007020;">int</span>,destination <span style="color:#007020;">varchar</span>,time_arrival <span style="color:#007020;">varchar</span>,loko_series <span style="color:#007020;">varchar</span>,loko_num_plan <span style="color:#007020;">varchar</span>,loko_driver_plan <span style="color:#007020;">varchar</span>,loko_num_fact <span style="color:#007020;">int</span>,loko_driver_fact <span style="color:#007020;">int</span>,comment_dcs <span style="color:#007020;">int</span>,tip_loc <span style="color:#007020;">int</span>,turnaround <span style="color:#007020;">int</span>,LastDisl <span style="color:#007020;">int</span>,copied_to <span style="color:#007020;">int</span>,station_formirovania <span style="color:#007020;">varchar</span>,<span style="color:#008800;font-weight:bold;">operation</span> <span style="color:#007020;">varchar</span>,NOM_POEZD <span style="color:#007020;">varchar</span>,last_op_date <span style="color:#007020;">varchar</span>,last_station <span style="color:#007020;">varchar</span>,las_station_obj <span style="color:#007020;">numeric</span>,train_index <span style="color:#007020;">varchar</span>) 
SERVER tablocutr 
<span style="color:#008800;font-weight:bold;">OPTIONS</span> ( layer <span style="background-color:#fff0f0;">'dbo.StationPlanTST'</span> )

<span style="color:#008800;font-weight:bold;">CREATE</span> <span style="color:#008800;font-weight:bold;">OR</span> <span style="color:#008800;font-weight:bold;">REPLACE</span> <span style="color:#008800;font-weight:bold;">VIEW</span> tmvhi7n2.v_stationplantst <span style="color:#008800;font-weight:bold;">AS</span> 
<span style="color:#008800;font-weight:bold;">select</span> fid, geom, num, to_date(<span style="color:#007020;">date</span>, <span style="background-color:#fff0f0;">'YYYY-MM-DD'</span>) <span style="color:#007020;">date</span>,TO_TIMESTAMP(time_departure, <span style="background-color:#fff0f0;">'HH24:MI:SS'</span>)::TIME time_departure,TO_TIMESTAMP(time_departure_fact, <span style="background-color:#fff0f0;">'HH24:MI:SS'</span>)::TIME time_departure_fact,station,destination,TO_TIMESTAMP(time_arrival, <span style="background-color:#fff0f0;">'HH24:MI:SS'</span>)::TIME time_arrival,loko_series,loko_num_plan,loko_driver_plan,loko_num_fact,loko_driver_fact,comment_dcs,tip_loc,turnaround,LastDisl,copied_to,station_formirovania,<span style="color:#008800;font-weight:bold;">operation</span>,NOM_POEZD,TO_TIMESTAMP(last_op_date, <span style="background-color:#fff0f0;">'YYYY-MM-DD HH24:MI:SS.US'</span>) <span style="color:#008800;font-weight:bold;">as</span> last_op_date,last_station,las_station_obj,train_index
<span style="color:#008800;font-weight:bold;">from</span> tmvhi7n2.StationPlanTST
</pre></td></tr></tbody></table></div><p></p><p>Готово! Представление v_stationplantst содержит данные таблицы StationPlanTST из БД MSSQL в формате PostgreSQL</p></body></html>